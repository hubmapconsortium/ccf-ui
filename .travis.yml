language: node_js
node_js:
- '12'
sudo: required
dist: trusty
addons:
  chrome: stable
  sonarcloud:
    organization: "$SONAR_KEY"
    token:
      secure: "vIncL26bhY9qrrS9d83Bbwh26LGNHkdH3dC/cxvvYGHnXRjoNW+1/7FOK+sL59roMA0h/UMx4NXBJhMuB5xY1hTljyFF4NXxp/BbB/sG9Jng5U+cA0UE2ilRLwN+yXxEHoOxT1nhFEquX3lk4TKm7APA43HWZ30+BMG3MUXBot5pKsBRueZMHu+yLNNsBnFG7e6kWlVDMrniWfodTIHjTgq6tDm/Xoo3PNDM1b8Fzw/Oow+9GKCx8ofsS+Jnr/H00UnJ8AgLYuP2AnpwVp9/z1CmI1eiPbHSY6YN5G4fgBGRmk6G6+2QZqOX7ZAe27Zk3B3O2zzOBwDKsd7Mz9xNO3MbR05/KE53bXIDCMxavqHP7iBD5WLmdUE5FAqDthJaHcWvIqJHnsVGEWkyywM2jVEjW/4ejKELntjABOdlMmp63uxMVOfkDA3w+NOxuYUrrAz4OpM0I6bkEoUyHnjQ0JbTCJGUy9RtyY2jTge+oo/rt6M2x23749ffWkCCR0v0hw1NIWkdd98A6iKY3EwP/XjCnyc3p3nhwikcvUGYVful9grBNu5GOZQRpUCpDUPWGHlHxBhNzbb94jJNDKyZ/eX+snI0GoVaWYE+sLR2iDs4ffwOy2Xp2izhazahho+/dSWfTiksWzBmD5CjZj+oBP8ds2TJdly8VNaLTGdeCU4="

cache: npm
branches:
  only:
  - master
  - develop
  - develop-v2
  - "/^v\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/"
install:
  - npm ci
script: skip
jobs:
  include:
  - stage: test
    name: Run Tests
    if: NOT (tag IS present)
    script:
    - npm run test
    - sonar-scanner -X
  - stage: deploy
    name: Deploy staging to Netlify
    if: branch = develop AND type != pull_request
    script:
    - npm run build -- --base-href=/
    - echo "/ccf-ui-sampledata/* https://hubmapconsortium.github.io/ccf-ui-sampledata/:splat 200" > dist/ccf-ui/_redirects
    - echo "/* /index.html 200" >> dist/ccf-ui/_redirects
    - npm run compodoc
    deploy:
      provider: pages
      target-branch: staging
      skip-cleanup: true
      github-token: "$GITHUB_TOKEN"
      keep-history: false
      local-dir: dist/ccf-ui
      on:
        branch: develop
  - stage: deploy
    name: Deploy demo to GitHub Pages
    if: branch = master
    script:
    - npm run build -- --base-href=/ccf-ui/
    - cp dist/ccf-ui/index.html dist/ccf-ui/404.html
    - touch dist/ccf-ui/.nojekyll
    - npm run compodoc
    deploy:
      provider: pages
      skip-cleanup: true
      github-token: "$GITHUB_TOKEN"
      keep-history: false
      local-dir: dist/ccf-ui
      on:
        branch: master
  - stage: deploy
    name: Build and publish ccf-ui
    if: tag IS present
    script:
    - npm run build -- --base-href=/ccf-ui/
    - npm run compodoc
    before_deploy:
    - cd dist/ccf-ui
    after_deploy: &1
    - cd ../../
    deploy: &2
      provider: npm
      skip-cleanup: true
      email: "$NPM_EMAIL"
      api_key: "$NPM_TOKEN"
      on:
        tags: true
        repo: hubmapconsortium/ccf-ui
  - stage: test
    name: Test building production version on PRs
    if: type = pull_request
    script:
    - npm run build -- --base-href=/
  - stage: test
    name: Test compodoc success on PRs
    if: type = pull_request
    script:
    - npm run compodoc
  - stage: test
    name: Run linter
    if: NOT (tag IS present)
    script:
    - npm run lint
notifications:
  slack:
    secure: kmHjR6duu+E+c+JEBLjECE5mSboVOrz599dOubVU7eqwVNUGvbe3YDGIKAc0S6akqsW0q9bVUWM2Zi+J4ROHrlMi1A+VQRJAW+2DG+6wu8fmdZiA0u/fK2w9IMRPFDDk80mMZN7TzSPMu5nRv6UGbVqpNeqRWotd2XtyLOu3+KRYKggUjKKz5D3oiYYGaHZWj6foDG7u42q33RQ55LlWff0GmAUuYVSfOUlxAYevOTuV9QF8NfFRnlQAfIYucM9177dd9cfWUdRgWPL7VGDUrANF2NtrfTUcWMM/zl6Vk7KMTxcCr1Oy0osxPE4DlpD8Mdz+i54tqKtcopJirBUnogZx+6MoMqMpTu7mU9pmB1H5rhAqlddYUMxiiyUvAvsScm3G5tY7azvqB0i6qalveTXuZWTa3CZUKHHTkDaDd0tnCvnLqWUaxZ2TeS//67q4EvreTfIdD4hD4phXjqfS+x0Ha8w7MpjwNln651svxsnpv+Ak6ET8N/NVRY61LhzAocMHitqMZMycTgyf8l5rciUtWE2cIuDiH86SBF+KeDYnoCCBwN8qXUTktVie37PeBX2drO84wNc8tmzjpIguXyCQUCBN/t0BodC4BIH+/oasfsYtKpXj6LQaV4/brf+t+hZX2FYssS44UZAKn3CQ92Mp7YurngUMHBqaMC6wPu4=
