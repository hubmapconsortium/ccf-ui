import { readQuads } from 'triple-store-utils';
import { ccf, entity, rui } from '../util/prefixes';
function getSpatialEntityMapping(subjects, store) {
    const spatial2entity = new Map();
    for (const subject of subjects) {
        for (const quad of readQuads(store, subject, entity.spatialEntity, null, null)) {
            if (!spatial2entity.has(quad.object.id)) {
                spatial2entity.set(quad.object.id, new Set([subject]));
            }
            else {
                spatial2entity.get(quad.object.id).add(subject);
            }
        }
    }
    return spatial2entity;
}
function getAnatomicalStructureMapping(ids, store) {
    const spatial2entity = getSpatialEntityMapping(ids, store);
    const term2entity = new Map();
    for (const subject of spatial2entity.keys()) {
        const entities = spatial2entity.get(subject);
        for (const quad of readQuads(store, subject, ccf.spatialEntity.ccf_annotations, null, null)) {
            if (!term2entity.has(quad.object.id)) {
                term2entity.set(quad.object.id, new Set(entities));
            }
            else {
                const termEntities = term2entity.get(quad.object.id);
                entities.forEach((value) => termEntities.add(value));
            }
        }
    }
    return term2entity;
}
/**
 * Get number of occurrences of ontology terms for a set of ids.
 *
 * @param ids Ids of objects to calculate aggregate over.
 * @param store The triple store.
 * @returns Ontology term counts.
 */
export function getOntologyTermOccurences(ids, store) {
    const counts = {};
    const term2entities = getAnatomicalStructureMapping(ids, store);
    term2entities.forEach((value, key) => {
        counts[key] = value.size;
    });
    return counts;
}
/**
 * Get number of occurrences of cell type terms for a set of ids.
 *
 * @param ids Ids of objects to calculate aggregate over.
 * @param store The triple store.
 * @returns Ontology term counts.
 */
export function getCellTypeTermOccurences(ids, store) {
    var _a, _b;
    const asTerm2entities = getAnatomicalStructureMapping(ids, store);
    const ctTerm2entities = new Map();
    for (const asTerm of asTerm2entities.keys()) {
        const entities = asTerm2entities.get(asTerm);
        for (const quad of readQuads(store, null, ccf.asctb.located_in, asTerm, null)) {
            const cellType = quad.subject.id;
            if (!ctTerm2entities.has(cellType)) {
                ctTerm2entities.set(cellType, new Set(entities));
            }
            else {
                const termEntities = ctTerm2entities.get(cellType);
                entities.forEach((value) => termEntities.add(value));
            }
        }
    }
    const counts = {};
    ctTerm2entities.forEach((value, key) => {
        counts[key] = value.size;
    });
    counts[rui.cell.id] = (_b = (_a = asTerm2entities.get(rui.body.id)) === null || _a === void 0 ? void 0 : _a.size) !== null && _b !== void 0 ? _b : 0;
    return counts;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib250b2xvZ3ktdGVybS1vY2N1cmVuY2VzLW4zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvY2NmLWRhdGFiYXNlL3NyYy9saWIvcXVlcmllcy9vbnRvbG9neS10ZXJtLW9jY3VyZW5jZXMtbjMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFTLFNBQVMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXRELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBR3BELFNBQVMsdUJBQXVCLENBQUMsUUFBcUIsRUFBRSxLQUFZO0lBQ2xFLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxFQUF1QixDQUFDO0lBRXRELEtBQUssTUFBTSxPQUFPLElBQUksUUFBUSxFQUFFO1FBQzlCLEtBQUssTUFBTSxJQUFJLElBQUksU0FBUyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDOUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDdkMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLEdBQUcsQ0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNoRTtpQkFBTTtnQkFDTCxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ2xEO1NBQ0Y7S0FDRjtJQUNELE9BQU8sY0FBYyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxTQUFTLDZCQUE2QixDQUFDLEdBQWdCLEVBQUUsS0FBWTtJQUNuRSxNQUFNLGNBQWMsR0FBRyx1QkFBdUIsQ0FB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Q3JDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO0lBQzNCLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBQSxNQUFBLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsMENBQUUsSUFBSSxtQ0FBSSxDQUFDLENBQUM7SUFFbEUsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0b3JlLCByZWFkUXVhZHMgfSBmcm9tICd0cmlwbGUtc3RvcmUtdXRpbHMnO1xuXG5pbXBvcnQgeyBjY2YsIGVudGl0eSwgcnVpIH0gZnJvbSAnLi4vdXRpbC9wcmVmaXhlcyc7XG5cblxuZnVuY3Rpb24gZ2V0U3BhdGlhbEVudGl0eU1hcHBpbmcoc3ViamVjdHM6IFNldDxzdHJpbmc+LCBzdG9yZTogU3RvcmUpOiBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4ge1xuICBjb25zdCBzcGF0aWFsMmVudGl0eSA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKTtcblxuICBmb3IgKGNvbnN0IHN1YmplY3Qgb2Ygc3ViamVjdHMpIHtcbiAgICBmb3IgKGNvbnN0IHF1YWQgb2YgcmVhZFF1YWRzKHN0b3JlLCBzdWJqZWN0LCBlbnRpdHkuc3BhdGlhbEVudGl0eSwgbnVsbCwgbnVsbCkpIHtcbiAgICAgIGlmICghc3BhdGlhbDJlbnRpdHkuaGFzKHF1YWQub2JqZWN0LmlkKSkge1xuICAgICAgICBzcGF0aWFsMmVudGl0eS5zZXQocXVhZC5vYmplY3QuaWQsIG5ldyBTZXQ8c3RyaW5nPihbc3ViamVjdF0pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNwYXRpYWwyZW50aXR5LmdldChxdWFkLm9iamVjdC5pZCkhLmFkZChzdWJqZWN0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHNwYXRpYWwyZW50aXR5O1xufVxuXG5mdW5jdGlvbiBnZXRBbmF0b21pY2FsU3RydWN0dXJlTWFwcGluZyhpZHM6IFNldDxzdHJpbmc+LCBzdG9yZTogU3RvcmUpOiBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4ge1xuICBjb25zdCBzcGF0aWFsMmVudGl0eSA9IGdldFNwYXRpYWxFbnRpdHlNYXBwaW5nKGlkcywgc3RvcmUpO1xuICBjb25zdCB0ZXJtMmVudGl0eSA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKTtcblxuICBmb3IgKGNvbnN0IHN1YmplY3Qgb2Ygc3BhdGlhbDJlbnRpdHkua2V5cygpKSB7XG4gICAgY29uc3QgZW50aXRpZXMgPSBzcGF0aWFsMmVudGl0eS5nZXQoc3ViamVjdCkhO1xuICAgIGZvciAoY29uc3QgcXVhZCBvZiByZWFkUXVhZHMoc3RvcmUsIHN1YmplY3QsIGNjZi5zcGF0aWFsRW50aXR5LmNjZl9hbm5vdGF0aW9ucywgbnVsbCwgbnVsbCkpIHtcbiAgICAgIGlmICghdGVybTJlbnRpdHkuaGFzKHF1YWQub2JqZWN0LmlkKSkge1xuICAgICAgICB0ZXJtMmVudGl0eS5zZXQocXVhZC5vYmplY3QuaWQsIG5ldyBTZXQ8c3RyaW5nPihlbnRpdGllcykpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgdGVybUVudGl0aWVzID0gdGVybTJlbnRpdHkuZ2V0KHF1YWQub2JqZWN0LmlkKSE7XG4gICAgICAgIGVudGl0aWVzLmZvckVhY2goKHZhbHVlKSA9PiB0ZXJtRW50aXRpZXMuYWRkKHZhbHVlKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiB0ZXJtMmVudGl0eTtcbn1cblxuLyoqXG4gKiBHZXQgbnVtYmVyIG9mIG9jY3VycmVuY2VzIG9mIG9udG9sb2d5IHRlcm1zIGZvciBhIHNldCBvZiBpZHMuXG4gKlxuICogQHBhcmFtIGlkcyBJZHMgb2Ygb2JqZWN0cyB0byBjYWxjdWxhdGUgYWdncmVnYXRlIG92ZXIuXG4gKiBAcGFyYW0gc3RvcmUgVGhlIHRyaXBsZSBzdG9yZS5cbiAqIEByZXR1cm5zIE9udG9sb2d5IHRlcm0gY291bnRzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0T250b2xvZ3lUZXJtT2NjdXJlbmNlcyhpZHM6IFNldDxzdHJpbmc+LCBzdG9yZTogU3RvcmUpOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+IHtcbiAgY29uc3QgY291bnRzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG4gIGNvbnN0IHRlcm0yZW50aXRpZXMgPSBnZXRBbmF0b21pY2FsU3RydWN0dXJlTWFwcGluZyhpZHMsIHN0b3JlKTtcblxuICB0ZXJtMmVudGl0aWVzLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICBjb3VudHNba2V5XSA9IHZhbHVlLnNpemU7XG4gIH0pO1xuXG4gIHJldHVybiBjb3VudHM7XG59XG5cbi8qKlxuICogR2V0IG51bWJlciBvZiBvY2N1cnJlbmNlcyBvZiBjZWxsIHR5cGUgdGVybXMgZm9yIGEgc2V0IG9mIGlkcy5cbiAqXG4gKiBAcGFyYW0gaWRzIElkcyBvZiBvYmplY3RzIHRvIGNhbGN1bGF0ZSBhZ2dyZWdhdGUgb3Zlci5cbiAqIEBwYXJhbSBzdG9yZSBUaGUgdHJpcGxlIHN0b3JlLlxuICogQHJldHVybnMgT250b2xvZ3kgdGVybSBjb3VudHMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDZWxsVHlwZVRlcm1PY2N1cmVuY2VzKGlkczogU2V0PHN0cmluZz4sIHN0b3JlOiBTdG9yZSk6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4ge1xuICBjb25zdCBhc1Rlcm0yZW50aXRpZXMgPSBnZXRBbmF0b21pY2FsU3RydWN0dXJlTWFwcGluZyhpZHMsIHN0b3JlKTtcbiAgY29uc3QgY3RUZXJtMmVudGl0aWVzID0gbmV3IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PigpO1xuXG4gIGZvciAoY29uc3QgYXNUZXJtIG9mIGFzVGVybTJlbnRpdGllcy5rZXlzKCkpIHtcbiAgICBjb25zdCBlbnRpdGllcyA9IGFzVGVybTJlbnRpdGllcy5nZXQoYXNUZXJtKSE7XG4gICAgZm9yIChjb25zdCBxdWFkIG9mIHJlYWRRdWFkcyhzdG9yZSwgbnVsbCwgY2NmLmFzY3RiLmxvY2F0ZWRfaW4sIGFzVGVybSwgbnVsbCkpIHtcbiAgICAgIGNvbnN0IGNlbGxUeXBlID0gcXVhZC5zdWJqZWN0LmlkO1xuICAgICAgaWYgKCFjdFRlcm0yZW50aXRpZXMuaGFzKGNlbGxUeXBlKSkge1xuICAgICAgICBjdFRlcm0yZW50aXRpZXMuc2V0KGNlbGxUeXBlLCBuZXcgU2V0PHN0cmluZz4oZW50aXRpZXMpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHRlcm1FbnRpdGllcyA9IGN0VGVybTJlbnRpdGllcy5nZXQoY2VsbFR5cGUpITtcbiAgICAgICAgZW50aXRpZXMuZm9yRWFjaCgodmFsdWUpID0+IHRlcm1FbnRpdGllcy5hZGQodmFsdWUpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBjb3VudHM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcblxuICBjdFRlcm0yZW50aXRpZXMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgIGNvdW50c1trZXldID0gdmFsdWUuc2l6ZTtcbiAgfSk7XG5cbiAgY291bnRzW3J1aS5jZWxsLmlkXSA9IGFzVGVybTJlbnRpdGllcy5nZXQocnVpLmJvZHkuaWQpPy5zaXplID8/IDA7XG5cbiAgcmV0dXJuIGNvdW50cztcbn1cbiJdfQ==