import { memoize } from 'lodash';
import { readQuads } from 'triple-store-utils';
import { getEntries } from '../util/n3-functions';
import { ccf, rui } from '../util/prefixes';
export function getOntologyTreeNode(store, iri, relationshipIri) {
    const result = {
        '@id': iri, '@type': 'OntologyTreeNode', id: iri, parent: '',
        children: [], synonymLabels: [], label: ''
    };
    const ontologyTreeNodeResult = {
        [ccf.ontologyNode.label.id]: 'label',
        [relationshipIri]: 'parent',
        [ccf.ontologyNode.synonymLabels.id]: 'synonymLabels',
    };
    for (const [key, value] of getEntries(store, iri, ontologyTreeNodeResult)) {
        if (key === 'synonymLabels') {
            result.synonymLabels.push(value);
        }
        else {
            result[key] = value;
        }
    }
    result.children = store.getSubjects(relationshipIri, iri, null).map(s => s.id);
    return result;
}
export function getOntologyTreeModel(store, rootIri, rootLabel, relationshipIri) {
    const result = { root: rootIri, nodes: {} };
    const seen = new Set();
    for (const quad of readQuads(store, null, relationshipIri, null, null)) {
        seen.add(quad.subject.id);
        seen.add(quad.object.id);
    }
    for (const iri of seen) {
        result.nodes[iri] = getOntologyTreeNode(store, iri, relationshipIri);
    }
    if (!result.nodes[rootIri]) {
        result.nodes[rootIri] = {
            '@id': rootIri,
            '@type': 'OntologyTreeNode',
            id: rootIri,
            label: rootLabel,
            children: [],
            synonymLabels: []
        };
    }
    const rootChildren = store
        .getSubjects(relationshipIri, rootIri, null).map(o => o.id)
        .sort((a, b) => result.nodes[a].label.localeCompare(result.nodes[b].label));
    result.nodes[rootIri].children = rootChildren;
    treeify(result);
    return result;
}
/**
 * Recursive function to ensure that the given ontology tree model is actually a tree by essentially using a BFS search.
 *
 * @param model the ontology tree model to mutate
 * @param nodeIri the tree node iri to modify. Starts at root in the base case
 * @param seen a set of IRIs that have been 'seen' so far to remove loops in the graph
 */
function treeify(model, nodeIri = undefined, seen = new Set()) {
    const node = model.nodes[nodeIri !== null && nodeIri !== void 0 ? nodeIri : model.root];
    if (node) {
        node.children = node.children.filter(n => !seen.has(n));
        node.children.forEach(n => seen.add(n));
        for (const childId of node.children) {
            treeify(model, childId, seen);
            if (model.nodes[childId]) {
                model.nodes[childId].parent = node['@id'];
            }
        }
    }
}
export function getAnatomicalStructureTreeModelSlowly(store) {
    const model = getOntologyTreeModel(store, rui.body.id, 'body', ccf.asctb.part_of.id);
    model.nodes[rui.body.id].children = [
        'http://purl.obolibrary.org/obo/UBERON_0000955',
        'http://purl.obolibrary.org/obo/UBERON_0000029',
        // 'http://purl.obolibrary.org/obo/UBERON_0002509', // Mesenteric Lymph Node
        'http://purl.obolibrary.org/obo/UBERON_0000970',
        // 'http://purl.obolibrary.org/obo/UBERON_0004548', // Eye, L
        // 'http://purl.org/sig/ont/fma/fma54449', // Eye, R
        'http://purl.obolibrary.org/obo/UBERON_0003889',
        // 'http://purl.obolibrary.org/obo/UBERON_0001303', // Fallopian Tube, L
        // 'http://purl.obolibrary.org/obo/UBERON_0001302', // Fallopian Tube, R
        'http://purl.obolibrary.org/obo/UBERON_0000948',
        'http://purl.obolibrary.org/obo/UBERON_0002113',
        // 'http://purl.obolibrary.org/obo/UBERON_0004538', // Kidney, L
        // 'http://purl.obolibrary.org/obo/UBERON_0004539', // Kidney, R
        'http://purl.obolibrary.org/obo/UBERON_0001465',
        // 'http://purl.org/sig/ont/fma/fma24978', // Knee, L
        // 'http://purl.org/sig/ont/fma/fma24977', // Knee, R
        'http://purl.obolibrary.org/obo/UBERON_0002107',
        'http://purl.obolibrary.org/obo/UBERON_0002048',
        'http://purl.obolibrary.org/obo/UBERON_0001911',
        // 'http://purl.org/sig/ont/fma/fma57991', // Mammary Gland, L
        // 'http://purl.org/sig/ont/fma/fma57987', // Mammary Gland, R
        'http://purl.obolibrary.org/obo/UBERON_0000992',
        // 'http://purl.org/sig/ont/fma/fma7214', // Ovary, L
        // 'http://purl.org/sig/ont/fma/fma7213', // Ovary, R
        'http://purl.obolibrary.org/obo/UBERON_0001264',
        'http://purl.obolibrary.org/obo/UBERON_0001270',
        'http://purl.obolibrary.org/obo/UBERON_0001987',
        'http://purl.obolibrary.org/obo/UBERON_0002367',
        'http://purl.obolibrary.org/obo/UBERON_0002097',
        'http://purl.obolibrary.org/obo/UBERON_0002108',
        'http://purl.obolibrary.org/obo/UBERON_0002240',
        'http://purl.obolibrary.org/obo/UBERON_0000059',
        'http://purl.obolibrary.org/obo/UBERON_0002106',
        'http://purl.obolibrary.org/obo/UBERON_0002370',
        'http://purl.obolibrary.org/obo/UBERON_0000056',
        // 'http://purl.obolibrary.org/obo/UBERON_0001223', // Ureter, L
        // 'http://purl.obolibrary.org/obo/UBERON_0001222', // Ureter, R
        'http://purl.obolibrary.org/obo/UBERON_0001255',
        'http://purl.obolibrary.org/obo/UBERON_0000995',
        'http://purl.obolibrary.org/obo/UBERON_0004537' // Blood Vasculature
    ].filter(iri => iri in model.nodes);
    return model;
}
export const getAnatomicalStructureTreeModel = memoize(getAnatomicalStructureTreeModelSlowly, () => '');
export function getCellTypeTreeModel(store) {
    return getOntologyTreeModel(store, rui.cell.id, 'cell', ccf.asctb.ct_is_a.id);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib250b2xvZ3ktdHJlZS1uMy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NjZi1kYXRhYmFzZS9zcmMvbGliL3F1ZXJpZXMvb250b2xvZ3ktdHJlZS1uMy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxTQUFTLEVBQVMsTUFBTSxvQkFBb0IsQ0FBQztBQUV0RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUc1QyxNQUFNLFVBQVUsbUJBQW1CLENBQUMsS0FBWSxFQUFFLEdBQVcsRUFBRSxlQUF1QjtJQUNwRixNQUFNLE1BQU0sR0FBcUI7UUFDL0IsS0FBSyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUM1RCxRQUFRLEVBQUUsRUFBYyxFQUFFLGFBQWEsRUFBRSxFQUFjLEVBQUUsS0FBSyxFQUFFLEVBQUU7S0FDbkUsQ0FBQztJQUVGLE1BQU0sc0JBQXNCLEdBQUc7UUFDN0IsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsRUFBRSxPQUFPO1FBQ3BDLENBQUMsZUFBZSxDQUFDLEVBQUUsUUFBUTtRQUMzQixDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFLGVBQWU7S0FDckQsQ0FBQztJQUVGLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxVQUFVLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxzQkFBc0IsQ0FBQyxFQUFFO1FBQ3pFLElBQUksR0FBRyxLQUFLLGVBQWUsRUFBRTtZQUMzQixNQUFNLENB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QUErQztRQUMvQywrQ0FBK0M7UUFDL0MsK0NBQStDO1FBQy9DLCtDQUErQztRQUMvQywrQ0FBK0M7UUFDL0MsK0NBQStDO1FBQy9DLCtDQUErQztRQUMvQyxnRUFBZ0U7UUFDaEUsZ0VBQWdFO1FBQ2hFLCtDQUErQztRQUMvQywrQ0FBK0M7UUFDL0MsK0NBQStDLENBQUMsb0JBQW9CO0tBQ3JFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNwQyxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSwrQkFBK0IsR0FBRyxPQUFPLENBQUMscUNBQXFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFeEcsTUFBTSxVQUFVLG9CQUFvQixDQUFDLEtBQVk7SUFDL0MsT0FBTyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2hGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtZW1vaXplIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHJlYWRRdWFkcywgU3RvcmUgfSBmcm9tICd0cmlwbGUtc3RvcmUtdXRpbHMnO1xuaW1wb3J0IHsgT250b2xvZ3lUcmVlTW9kZWwsIE9udG9sb2d5VHJlZU5vZGUgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGdldEVudHJpZXMgfSBmcm9tICcuLi91dGlsL24zLWZ1bmN0aW9ucyc7XG5pbXBvcnQgeyBjY2YsIHJ1aSB9IGZyb20gJy4uL3V0aWwvcHJlZml4ZXMnO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRPbnRvbG9neVRyZWVOb2RlKHN0b3JlOiBTdG9yZSwgaXJpOiBzdHJpbmcsIHJlbGF0aW9uc2hpcElyaTogc3RyaW5nKTogT250b2xvZ3lUcmVlTm9kZSB7XG4gIGNvbnN0IHJlc3VsdDogT250b2xvZ3lUcmVlTm9kZSA9IHtcbiAgICAnQGlkJzogaXJpLCAnQHR5cGUnOiAnT250b2xvZ3lUcmVlTm9kZScsIGlkOiBpcmksIHBhcmVudDogJycsXG4gICAgY2hpbGRyZW46IFtdIGFzIHN0cmluZ1tdLCBzeW5vbnltTGFiZWxzOiBbXSBhcyBzdHJpbmdbXSwgbGFiZWw6ICcnXG4gIH07XG5cbiAgY29uc3Qgb250b2xvZ3lUcmVlTm9kZVJlc3VsdCA9IHtcbiAgICBbY2NmLm9udG9sb2d5Tm9kZS5sYWJlbC5pZF06ICdsYWJlbCcsXG4gICAgW3JlbGF0aW9uc2hpcElyaV06ICdwYXJlbnQnLFxuICAgIFtjY2Yub250b2xvZ3lOb2RlLnN5bm9ueW1MYWJlbHMuaWRdOiAnc3lub255bUxhYmVscycsXG4gIH07XG5cbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgZ2V0RW50cmllcyhzdG9yZSwgaXJpLCBvbnRvbG9neVRyZWVOb2RlUmVzdWx0KSkge1xuICAgIGlmIChrZXkgPT09ICdzeW5vbnltTGFiZWxzJykge1xuICAgICAgcmVzdWx0LnN5bm9ueW1MYWJlbHMucHVzaCh2YWx1ZSBhcyBzdHJpbmcpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuICByZXN1bHQuY2hpbGRyZW4gPSBzdG9yZS5nZXRTdWJqZWN0cyhyZWxhdGlvbnNoaXBJcmksIGlyaSwgbnVsbCkubWFwKHMgPT4gcy5pZCk7XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9udG9sb2d5VHJlZU1vZGVsKHN0b3JlOiBTdG9yZSwgcm9vdElyaTogc3RyaW5nLCByb290TGFiZWw6IHN0cmluZywgcmVsYXRpb25zaGlwSXJpOiBzdHJpbmcpOiBPbnRvbG9neVRyZWVNb2RlbCB7XG4gIGNvbnN0IHJlc3VsdDogT250b2xvZ3lUcmVlTW9kZWwgPSB7IHJvb3Q6IHJvb3RJcmksIG5vZGVzOiB7fSB9O1xuICBjb25zdCBzZWVuID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIGZvciAoY29uc3QgcXVhZCBvZiByZWFkUXVhZHMoc3RvcmUsIG51bGwsIHJlbGF0aW9uc2hpcElyaSwgbnVsbCwgbnVsbCkpIHtcbiAgICBzZWVuLmFkZChxdWFkLnN1YmplY3QuaWQpO1xuICAgIHNlZW4uYWRkKHF1YWQub2JqZWN0LmlkKTtcbiAgfVxuXG4gIGZvciAoY29uc3QgaXJpIG9mIHNlZW4pIHtcbiAgICByZXN1bHQubm9kZXNbaXJpXSA9IGdldE9udG9sb2d5VHJlZU5vZGUoc3RvcmUsIGlyaSwgcmVsYXRpb25zaGlwSXJpKTtcbiAgfVxuXG4gIGlmICghcmVzdWx0Lm5vZGVzW3Jvb3RJcmldKSB7XG4gICAgcmVzdWx0Lm5vZGVzW3Jvb3RJcmldID0ge1xuICAgICAgJ0BpZCc6IHJvb3RJcmksXG4gICAgICAnQHR5cGUnOiAnT250b2xvZ3lUcmVlTm9kZScsXG4gICAgICBpZDogcm9vdElyaSxcbiAgICAgIGxhYmVsOiByb290TGFiZWwsXG4gICAgICBjaGlsZHJlbjogW10sXG4gICAgICBzeW5vbnltTGFiZWxzOiBbXVxuICAgIH0gYXMgdW5rbm93biBhcyBPbnRvbG9neVRyZWVOb2RlO1xuICB9XG5cbiAgY29uc3Qgcm9vdENoaWxkcmVuID0gc3RvcmVcbiAgICAuZ2V0U3ViamVjdHMocmVsYXRpb25zaGlwSXJpLCByb290SXJpLCBudWxsKS5tYXAobyA9PiBvLmlkKVxuICAgIC5zb3J0KChhLCBiKSA9PiByZXN1bHQubm9kZXNbYV0ubGFiZWwubG9jYWxlQ29tcGFyZShyZXN1bHQubm9kZXNbYl0ubGFiZWwpKTtcbiAgcmVzdWx0Lm5vZGVzW3Jvb3RJcmldLmNoaWxkcmVuID0gcm9vdENoaWxkcmVuO1xuXG4gIHRyZWVpZnkocmVzdWx0KTtcblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG4vKipcbiAqIFJlY3Vyc2l2ZSBmdW5jdGlvbiB0byBlbnN1cmUgdGhhdCB0aGUgZ2l2ZW4gb250b2xvZ3kgdHJlZSBtb2RlbCBpcyBhY3R1YWxseSBhIHRyZWUgYnkgZXNzZW50aWFsbHkgdXNpbmcgYSBCRlMgc2VhcmNoLlxuICpcbiAqIEBwYXJhbSBtb2RlbCB0aGUgb250b2xvZ3kgdHJlZSBtb2RlbCB0byBtdXRhdGVcbiAqIEBwYXJhbSBub2RlSXJpIHRoZSB0cmVlIG5vZGUgaXJpIHRvIG1vZGlmeS4gU3RhcnRzIGF0IHJvb3QgaW4gdGhlIGJhc2UgY2FzZVxuICogQHBhcmFtIHNlZW4gYSBzZXQgb2YgSVJJcyB0aGF0IGhhdmUgYmVlbiAnc2Vlbicgc28gZmFyIHRvIHJlbW92ZSBsb29wcyBpbiB0aGUgZ3JhcGhcbiAqL1xuZnVuY3Rpb24gdHJlZWlmeShtb2RlbDogT250b2xvZ3lUcmVlTW9kZWwsIG5vZGVJcmk6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZCwgc2VlbjogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCkpIHtcbiAgY29uc3Qgbm9kZSA9IG1vZGVsLm5vZGVzW25vZGVJcmkgPz8gbW9kZWwucm9vdF07XG4gIGlmIChub2RlKSB7XG4gICAgbm9kZS5jaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW4uZmlsdGVyKG4gPT4gIXNlZW4uaGFzKG4pKTtcbiAgICBub2RlLmNoaWxkcmVuLmZvckVhY2gobiA9PiBzZWVuLmFkZChuKSk7XG4gICAgZm9yIChjb25zdCBjaGlsZElkIG9mIG5vZGUuY2hpbGRyZW4pIHtcbiAgICAgIHRyZWVpZnkobW9kZWwsIGNoaWxkSWQsIHNlZW4pO1xuICAgICAgaWYgKG1vZGVsLm5vZGVzW2NoaWxkSWRdKSB7XG4gICAgICAgIG1vZGVsLm5vZGVzW2NoaWxkSWRdLnBhcmVudCA9IG5vZGVbJ0BpZCddO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QW5hdG9taWNhbFN0cnVjdHVyZVRyZWVNb2RlbFNsb3dseShzdG9yZTogU3RvcmUpOiBPbnRvbG9neVRyZWVNb2RlbCB7XG4gIGNvbnN0IG1vZGVsID0gZ2V0T250b2xvZ3lUcmVlTW9kZWwoc3RvcmUsIHJ1aS5ib2R5LmlkLCAnYm9keScsIGNjZi5hc2N0Yi5wYXJ0X29mLmlkKTtcbiAgbW9kZWwubm9kZXNbcnVpLmJvZHkuaWRdLmNoaWxkcmVuID0gW1xuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDA5NTUnLCAvLyBCcmFpblxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDAwMjknLCAvLyBMeW1waCBOb2RlXG4gICAgLy8gJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwMjUwOScsIC8vIE1lc2VudGVyaWMgTHltcGggTm9kZVxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDA5NzAnLCAvLyBFeWVcbiAgICAvLyAnaHR0cDovL3B1cmwub2JvbGlicmFyeS5vcmcvb2JvL1VCRVJPTl8wMDA0NTQ4JywgLy8gRXllLCBMXG4gICAgLy8gJ2h0dHA6Ly9wdXJsLm9yZy9zaWcvb250L2ZtYS9mbWE1NDQ0OScsIC8vIEV5ZSwgUlxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDM4ODknLCAvLyBGYWxsb3BpYW4gVHViZVxuICAgIC8vICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDEzMDMnLCAvLyBGYWxsb3BpYW4gVHViZSwgTFxuICAgIC8vICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDEzMDInLCAvLyBGYWxsb3BpYW4gVHViZSwgUlxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDA5NDgnLCAvLyBIZWFydFxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDIxMTMnLCAvLyBLaWRuZXlcbiAgICAvLyAnaHR0cDovL3B1cmwub2JvbGlicmFyeS5vcmcvb2JvL1VCRVJPTl8wMDA0NTM4JywgLy8gS2lkbmV5LCBMXG4gICAgLy8gJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwNDUzOScsIC8vIEtpZG5leSwgUlxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDE0NjUnLCAvLyBLbmVlXG4gICAgLy8gJ2h0dHA6Ly9wdXJsLm9yZy9zaWcvb250L2ZtYS9mbWEyNDk3OCcsIC8vIEtuZWUsIExcbiAgICAvLyAnaHR0cDovL3B1cmwub3JnL3NpZy9vbnQvZm1hL2ZtYTI0OTc3JywgLy8gS25lZSwgUlxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDIxMDcnLCAvLyBMaXZlclxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDIwNDgnLCAvLyBMdW5nc1xuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDE5MTEnLCAvLyBNYW1tYXJ5IEdsYW5kXG4gICAgLy8gJ2h0dHA6Ly9wdXJsLm9yZy9zaWcvb250L2ZtYS9mbWE1Nzk5MScsIC8vIE1hbW1hcnkgR2xhbmQsIExcbiAgICAvLyAnaHR0cDovL3B1cmwub3JnL3NpZy9vbnQvZm1hL2ZtYTU3OTg3JywgLy8gTWFtbWFyeSBHbGFuZCwgUlxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDA5OTInLCAvLyBPdmFyeVxuICAgIC8vICdodHRwOi8vcHVybC5vcmcvc2lnL29udC9mbWEvZm1hNzIxNCcsIC8vIE92YXJ5LCBMXG4gICAgLy8gJ2h0dHA6Ly9wdXJsLm9yZy9zaWcvb250L2ZtYS9mbWE3MjEzJywgLy8gT3ZhcnksIFJcbiAgICAnaHR0cDovL3B1cmwub2JvbGlicmFyeS5vcmcvb2JvL1VCRVJPTl8wMDAxMjY0JywgLy8gUGFuY3JlYXNcbiAgICAnaHR0cDovL3B1cmwub2JvbGlicmFyeS5vcmcvb2JvL1VCRVJPTl8wMDAxMjcwJywgLy8gUGVsdmlzXG4gICAgJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwMTk4NycsIC8vIFBsYWNlbnRhXG4gICAgJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwMjM2NycsIC8vIFByb3N0YXRlXG4gICAgJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwMjA5NycsIC8vIFNraW5cbiAgICAnaHR0cDovL3B1cmwub2JvbGlicmFyeS5vcmcvb2JvL1VCRVJPTl8wMDAyMTA4JywgLy8gU21hbGwgSW50ZXN0aW5lXG4gICAgJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwMjI0MCcsIC8vIFNwaW5hbCBDb3JkXG4gICAgJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwMDA1OScsIC8vIExhcmdlIEludGVzdGluZVxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDIxMDYnLCAvLyBTcGxlZW5cbiAgICAnaHR0cDovL3B1cmwub2JvbGlicmFyeS5vcmcvb2JvL1VCRVJPTl8wMDAyMzcwJywgLy8gVGh5bXVzXG4gICAgJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwMDA1NicsIC8vIFVyZXRlclxuICAgIC8vICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDEyMjMnLCAvLyBVcmV0ZXIsIExcbiAgICAvLyAnaHR0cDovL3B1cmwub2JvbGlicmFyeS5vcmcvb2JvL1VCRVJPTl8wMDAxMjIyJywgLy8gVXJldGVyLCBSXG4gICAgJ2h0dHA6Ly9wdXJsLm9ib2xpYnJhcnkub3JnL29iby9VQkVST05fMDAwMTI1NScsIC8vIFVyaW5hcnkgQmxhZGRlclxuICAgICdodHRwOi8vcHVybC5vYm9saWJyYXJ5Lm9yZy9vYm8vVUJFUk9OXzAwMDA5OTUnLCAvLyBVdGVydXNcbiAgICAnaHR0cDovL3B1cmwub2JvbGlicmFyeS5vcmcvb2JvL1VCRVJPTl8wMDA0NTM3JyAvLyBCbG9vZCBWYXNjdWxhdHVyZVxuICBdLmZpbHRlcihpcmkgPT4gaXJpIGluIG1vZGVsLm5vZGVzKTtcbiAgcmV0dXJuIG1vZGVsO1xufVxuXG5leHBvcnQgY29uc3QgZ2V0QW5hdG9taWNhbFN0cnVjdHVyZVRyZWVNb2RlbCA9IG1lbW9pemUoZ2V0QW5hdG9taWNhbFN0cnVjdHVyZVRyZWVNb2RlbFNsb3dseSwgKCkgPT4gJycpO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2VsbFR5cGVUcmVlTW9kZWwoc3RvcmU6IFN0b3JlKTogT250b2xvZ3lUcmVlTW9kZWwge1xuICByZXR1cm4gZ2V0T250b2xvZ3lUcmVlTW9kZWwoc3RvcmUsIHJ1aS5jZWxsLmlkLCAnY2VsbCcsIGNjZi5hc2N0Yi5jdF9pc19hLmlkKTtcbn1cbiJdfQ==