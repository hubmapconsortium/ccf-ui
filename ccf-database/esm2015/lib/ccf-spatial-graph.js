/* eslint-disable @typescript-eslint/naming-convention */
/* eslint-disable @typescript-eslint/no-unsafe-call */
/* eslint-disable @typescript-eslint/no-unsafe-member-access */
import { Euler, Matrix4, toDegrees, toRadians } from '@math.gl/core';
import { DirectedGraph } from 'graphology';
import shortestPath from 'graphology-shortest-path/unweighted';
import { get } from 'lodash';
import { readQuads } from 'triple-store-utils';
import { v4 as uuidV4 } from 'uuid';
import { getSpatialPlacement } from './queries/spatial-result-n3';
import { ccf, rdf } from './util/prefixes';
export function applySpatialPlacement(tx, placement) {
    const p = placement;
    let factor;
    switch (p.translation_units) {
        case 'centimeter':
            factor = 1 / 100;
            break;
        case 'millimeter':
            factor = 1 / 1000;
            break;
        case 'meter':
        default:
            factor = 1;
            break;
    }
    const T = [p.x_translation, p.y_translation, p.z_translation].map(t => t * factor);
    const R = [p.x_rotation, p.y_rotation, p.z_rotation].map(toRadians);
    const S = [p.x_scaling, p.y_scaling, p.z_scaling];
    return tx.translate(T).rotateXYZ(R).scale(S);
}
export class CCFSpatialGraph {
    constructor(db) {
        this.db = db;
        this.createGraph();
    }
    createGraph() {
        this.graph = new DirectedGraph();
        const store = this.db.store;
        // Add all Spatial Object References
        store.forSubjects((subject) => {
            this.addNode(subject.id, 'SpatialObjectReference');
        }, rdf.type, ccf.SpatialObjectReference, null);
        // Add all Spatial Entities
        store.forSubjects((subject) => {
            this.addNode(subject.id, 'SpatialEntity');
        }, rdf.type, ccf.SpatialEntity, null);
        // Add all Spatial Placements
        const edgeSource = {};
        for (const quad of readQuads(store, null, ccf.spatialPlacement.source, null, null)) {
            edgeSource[quad.subject.id] = quad.object.id;
        }
        for (const quad of readQuads(store, null, ccf.spatialPlacement.target, null, null)) {
            const source = edgeSource[quad.subject.id];
            if (source) {
                this.addEdge(quad.subject.id, source, quad.object.id, 'SpatialPlacement');
            }
        }
    }
    addNode(id, type) {
        this.graph.mergeNode(id, { type });
    }
    addEdge(id, source, target, type) {
        this.graph.mergeDirectedEdge(source, target, { type, id });
    }
    getTransformationMatrix(sourceIRI, targetIRI) {
        if (sourceIRI === targetIRI) {
            return new Matrix4(Matrix4.IDENTITY); // identity
        }
        if (!this.graph.hasNode(sourceIRI) || !this.graph.hasNode(targetIRI)) {
            return undefined;
        }
        const store = this.db.store;
        const tx = new Matrix4(Matrix4.IDENTITY);
        const path = shortestPath(this.graph, sourceIRI, targetIRI);
        if (path && path.length > 0) {
            path.reverse();
            let target = '';
            for (const source of path) {
                if (target) {
                    const placementId = this.graph.getEdgeAttribute(source, target, 'id');
                    const placement = getSpatialPlacement(store, placementId);
                    applySpatialPlacement(tx, placement);
                }
                target = source;
            }
            return tx;
        }
        else {
            return undefined;
        }
    }
    getSpatialPlacement(source, targetIri) {
        const sourceIri = this.graph.hasNode(source['@id']) ? source['@id'] : undefined;
        const placement = get(source, 'placement[0]', get(source, 'placement', undefined));
        let matrix;
        if (placement && this.graph.hasNode(placement.target)) {
            matrix = this.getTransformationMatrix(placement.target, targetIri);
            if (matrix) {
                matrix = applySpatialPlacement(matrix, placement);
            }
        }
        else if (sourceIri) {
            matrix = this.getTransformationMatrix(sourceIri, targetIri);
        }
        if (matrix) {
            const euler = new Euler().fromRotationMatrix(matrix, Euler.XYZ);
            const T = matrix.getTranslation().map(n => n * 1000);
            const R = euler.toVector3().map(toDegrees);
            const S = matrix.getScale().map(n => n < 1 && n > 0.999999 ? 1 : n);
            return {
                '@context': 'https://hubmapconsortium.github.io/hubmap-ontology/ccf-context.jsonld',
                '@id': `http://purl.org/ccf/1.5/${uuidV4()}_placement`,
                '@type': 'SpatialPlacement',
                source: source['@id'],
                target: targetIri,
                placement_date: new Date().toISOString().split('T')[0],
                x_scaling: S[0],
                y_scaling: S[1],
                z_scaling: S[2],
                scaling_units: 'ratio',
                x_rotation: R[0],
                y_rotation: R[1],
                z_rotation: R[2],
                rotation_order: 'XYZ',
                rotation_units: 'degree',
                x_translation: T[0],
                y_translation: T[1],
                z_translation: T[2],
                translation_units: 'millimeter'
            };
        }
        else {
            return undefined;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2NmLXNwYXRpYWwtZ3JhcGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9jY2YtZGF0YWJhc2Uvc3JjL2xpYi9jY2Ytc3BhdGlhbC1ncmFwaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx5REFBeUQ7QUFDekQsc0RBQXNEO0FBQ3RELCtEQUErRDtBQUMvRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDM0MsT0FBTyxZQUFZLE1BQU0scUNBQXFDLENBQUM7QUFDL0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUM3QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLEVBQUUsSUFBSSxNQUFNLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFHcEMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFbEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUczQyxNQUFNLFVBQVUscUJBQXFCLENBQUMsRUFBVyxFQUFFLFNBQTJCO0lBQzVFLE1BQU0sQ0FBQyxHQUFHLFNBQVMsQ0FBQztJQUNwQixJQUFJLE1BQWMsQ0FBQztJQUNuQixRQUFRLENBQUMsQ0FBQyxpQkFBaUIsRUFBRTtRQUMzQixLQUFLLFlBQVk7WUFDZixNQUFNLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztZQUNqQixNQUFNO1FBQ1IsS0FBSyxZQUFZO1lBQ2YsTUFBTSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDbEIsTUFBTTtRQUNSLEtBQUssT0FBTyxDQUFDO1FBQ2I7WUFDRSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ1gsTUFBTTtLQUNUO0lBQ0QsTUFB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Q0FBQyxDQUFDLENBQUM7Z0JBQ25CLGlCQUFpQixFQUFFLFlBQVk7YUFDaEMsQ0FBQztTQUNIO2FBQU07WUFDTCxPQUFPLFNBQVMsQ0FBQztTQUNsQjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1jYWxsICovXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLW1lbWJlci1hY2Nlc3MgKi9cbmltcG9ydCB7IEV1bGVyLCBNYXRyaXg0LCB0b0RlZ3JlZXMsIHRvUmFkaWFucyB9IGZyb20gJ0BtYXRoLmdsL2NvcmUnO1xuaW1wb3J0IHsgRGlyZWN0ZWRHcmFwaCB9IGZyb20gJ2dyYXBob2xvZ3knO1xuaW1wb3J0IHNob3J0ZXN0UGF0aCBmcm9tICdncmFwaG9sb2d5LXNob3J0ZXN0LXBhdGgvdW53ZWlnaHRlZCc7XG5pbXBvcnQgeyBnZXQgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgcmVhZFF1YWRzIH0gZnJvbSAndHJpcGxlLXN0b3JlLXV0aWxzJztcbmltcG9ydCB7IHY0IGFzIHV1aWRWNCB9IGZyb20gJ3V1aWQnO1xuXG5pbXBvcnQgeyBDQ0ZEYXRhYmFzZSB9IGZyb20gJy4vY2NmLWRhdGFiYXNlJztcbmltcG9ydCB7IGdldFNwYXRpYWxQbGFjZW1lbnQgfSBmcm9tICcuL3F1ZXJpZXMvc3BhdGlhbC1yZXN1bHQtbjMnO1xuaW1wb3J0IHsgRmxhdFNwYXRpYWxQbGFjZW1lbnQsIFNwYXRpYWxFbnRpdHksIFNwYXRpYWxQbGFjZW1lbnQgfSBmcm9tICcuL3NwYXRpYWwtdHlwZXMnO1xuaW1wb3J0IHsgY2NmLCByZGYgfSBmcm9tICcuL3V0aWwvcHJlZml4ZXMnO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBhcHBseVNwYXRpYWxQbGFjZW1lbnQodHg6IE1hdHJpeDQsIHBsYWNlbWVudDogU3BhdGlhbFBsYWNlbWVudCk6IE1hdHJpeDQge1xuICBjb25zdCBwID0gcGxhY2VtZW50O1xuICBsZXQgZmFjdG9yOiBudW1iZXI7XG4gIHN3aXRjaCAocC50cmFuc2xhdGlvbl91bml0cykge1xuICAgIGNhc2UgJ2NlbnRpbWV0ZXInOlxuICAgICAgZmFjdG9yID0gMSAvIDEwMDtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ21pbGxpbWV0ZXInOlxuICAgICAgZmFjdG9yID0gMSAvIDEwMDA7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdtZXRlcic6XG4gICAgZGVmYXVsdDpcbiAgICAgIGZhY3RvciA9IDE7XG4gICAgICBicmVhaztcbiAgfVxuICBjb25zdCBUID0gW3AueF90cmFuc2xhdGlvbiwgcC55X3RyYW5zbGF0aW9uLCBwLnpfdHJhbnNsYXRpb25dLm1hcCh0ID0+IHQgKiBmYWN0b3IpO1xuICBjb25zdCBSID0gW3AueF9yb3RhdGlvbiwgcC55X3JvdGF0aW9uLCBwLnpfcm90YXRpb25dLm1hcDxudW1iZXI+KHRvUmFkaWFucykgYXMgW251bWJlciwgbnVtYmVyLCBudW1iZXJdO1xuICBjb25zdCBTID0gW3AueF9zY2FsaW5nLCBwLnlfc2NhbGluZywgcC56X3NjYWxpbmddO1xuXG4gIHJldHVybiB0eC50cmFuc2xhdGUoVCkucm90YXRlWFlaKFIpLnNjYWxlKFMpO1xufVxuXG5leHBvcnQgY2xhc3MgQ0NGU3BhdGlhbEdyYXBoIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgZ3JhcGg6IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRiOiBDQ0ZEYXRhYmFzZSkge1xuICAgIHRoaXMuY3JlYXRlR3JhcGgoKTtcbiAgfVxuXG4gIGNyZWF0ZUdyYXBoKCk6IHZvaWQge1xuICAgIHRoaXMuZ3JhcGggPSBuZXcgRGlyZWN0ZWRHcmFwaCgpO1xuICAgIGNvbnN0IHN0b3JlID0gdGhpcy5kYi5zdG9yZTtcblxuICAgIC8vIEFkZCBhbGwgU3BhdGlhbCBPYmplY3QgUmVmZXJlbmNlc1xuICAgIHN0b3JlLmZvclN1YmplY3RzKChzdWJqZWN0KSA9PiB7XG4gICAgICB0aGlzLmFkZE5vZGUoc3ViamVjdC5pZCwgJ1NwYXRpYWxPYmplY3RSZWZlcmVuY2UnKTtcbiAgICB9LCByZGYudHlwZSwgY2NmLlNwYXRpYWxPYmplY3RSZWZlcmVuY2UsIG51bGwpO1xuXG4gICAgLy8gQWRkIGFsbCBTcGF0aWFsIEVudGl0aWVzXG4gICAgc3RvcmUuZm9yU3ViamVjdHMoKHN1YmplY3QpID0+IHtcbiAgICAgIHRoaXMuYWRkTm9kZShzdWJqZWN0LmlkLCAnU3BhdGlhbEVudGl0eScpO1xuICAgIH0sIHJkZi50eXBlLCBjY2YuU3BhdGlhbEVudGl0eSwgbnVsbCk7XG5cbiAgICAvLyBBZGQgYWxsIFNwYXRpYWwgUGxhY2VtZW50c1xuICAgIGNvbnN0IGVkZ2VTb3VyY2U6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IHF1YWQgb2YgcmVhZFF1YWRzKHN0b3JlLCBudWxsLCBjY2Yuc3BhdGlhbFBsYWNlbWVudC5zb3VyY2UsIG51bGwsIG51bGwpKSB7XG4gICAgICBlZGdlU291cmNlW3F1YWQuc3ViamVjdC5pZF0gPSBxdWFkLm9iamVjdC5pZDtcbiAgICB9XG4gICAgZm9yIChjb25zdCBxdWFkIG9mIHJlYWRRdWFkcyhzdG9yZSwgbnVsbCwgY2NmLnNwYXRpYWxQbGFjZW1lbnQudGFyZ2V0LCBudWxsLCBudWxsKSkge1xuICAgICAgY29uc3Qgc291cmNlID0gZWRnZVNvdXJjZVtxdWFkLnN1YmplY3QuaWRdO1xuICAgICAgaWYgKHNvdXJjZSkge1xuICAgICAgICB0aGlzLmFkZEVkZ2UocXVhZC5zdWJqZWN0LmlkLCBzb3VyY2UsIHF1YWQub2JqZWN0LmlkLCAnU3BhdGlhbFBsYWNlbWVudCcpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFkZE5vZGUoaWQ6IHN0cmluZywgdHlwZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5ncmFwaC5tZXJnZU5vZGUoaWQsIHsgdHlwZSB9KTtcbiAgfVxuXG4gIGFkZEVkZ2UoaWQ6IHN0cmluZywgc291cmNlOiBzdHJpbmcsIHRhcmdldDogc3RyaW5nLCB0eXBlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmdyYXBoLm1lcmdlRGlyZWN0ZWRFZGdlKHNvdXJjZSwgdGFyZ2V0LCB7IHR5cGUsIGlkIH0pO1xuICB9XG5cbiAgZ2V0VHJhbnNmb3JtYXRpb25NYXRyaXgoc291cmNlSVJJOiBzdHJpbmcsIHRhcmdldElSSTogc3RyaW5nKTogTWF0cml4NCB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHNvdXJjZUlSSSA9PT0gdGFyZ2V0SVJJKSB7XG4gICAgICByZXR1cm4gbmV3IE1hdHJpeDQoTWF0cml4NC5JREVOVElUWSk7IC8vIGlkZW50aXR5XG4gICAgfVxuICAgIGlmICghdGhpcy5ncmFwaC5oYXNOb2RlKHNvdXJjZUlSSSkgfHwgIXRoaXMuZ3JhcGguaGFzTm9kZSh0YXJnZXRJUkkpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGNvbnN0IHN0b3JlID0gdGhpcy5kYi5zdG9yZTtcbiAgICBjb25zdCB0eCA9IG5ldyBNYXRyaXg0KE1hdHJpeDQuSURFTlRJVFkpO1xuICAgIGNvbnN0IHBhdGggPSBzaG9ydGVzdFBhdGgodGhpcy5ncmFwaCwgc291cmNlSVJJLCB0YXJnZXRJUkkpO1xuICAgIGlmIChwYXRoICYmIHBhdGgubGVuZ3RoID4gMCkge1xuICAgICAgcGF0aC5yZXZlcnNlKCk7XG4gICAgICBsZXQgdGFyZ2V0OiBzdHJpbmcgfCBudW1iZXIgPSAnJztcbiAgICAgIGZvciAoY29uc3Qgc291cmNlIG9mIHBhdGgpIHtcbiAgICAgICAgaWYgKHRhcmdldCkge1xuICAgICAgICAgIGNvbnN0IHBsYWNlbWVudElkID0gdGhpcy5ncmFwaC5nZXRFZGdlQXR0cmlidXRlKHNvdXJjZSwgdGFyZ2V0LCAnaWQnKTtcbiAgICAgICAgICBjb25zdCBwbGFjZW1lbnQgPSBnZXRTcGF0aWFsUGxhY2VtZW50KHN0b3JlLCBwbGFjZW1lbnRJZCk7XG4gICAgICAgICAgYXBwbHlTcGF0aWFsUGxhY2VtZW50KHR4LCBwbGFjZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIHRhcmdldCA9IHNvdXJjZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0eDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBnZXRTcGF0aWFsUGxhY2VtZW50KHNvdXJjZTogU3BhdGlhbEVudGl0eSwgdGFyZ2V0SXJpOiBzdHJpbmcpOiBGbGF0U3BhdGlhbFBsYWNlbWVudCB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3Qgc291cmNlSXJpID0gdGhpcy5ncmFwaC5oYXNOb2RlKHNvdXJjZVsnQGlkJ10pID8gc291cmNlWydAaWQnXSA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBwbGFjZW1lbnQ6IFNwYXRpYWxQbGFjZW1lbnQgPSBnZXQoc291cmNlLCAncGxhY2VtZW50WzBdJywgZ2V0KHNvdXJjZSwgJ3BsYWNlbWVudCcsIHVuZGVmaW5lZCkpO1xuXG4gICAgbGV0IG1hdHJpeDogTWF0cml4NCB8IHVuZGVmaW5lZDtcbiAgICBpZiAocGxhY2VtZW50ICYmIHRoaXMuZ3JhcGguaGFzTm9kZShwbGFjZW1lbnQudGFyZ2V0KSkge1xuICAgICAgbWF0cml4ID0gdGhpcy5nZXRUcmFuc2Zvcm1hdGlvbk1hdHJpeChwbGFjZW1lbnQudGFyZ2V0IGFzIHVua25vd24gYXMgc3RyaW5nLCB0YXJnZXRJcmkpO1xuICAgICAgaWYgKG1hdHJpeCkge1xuICAgICAgICBtYXRyaXggPSBhcHBseVNwYXRpYWxQbGFjZW1lbnQobWF0cml4LCBwbGFjZW1lbnQpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoc291cmNlSXJpKSB7XG4gICAgICBtYXRyaXggPSB0aGlzLmdldFRyYW5zZm9ybWF0aW9uTWF0cml4KHNvdXJjZUlyaSwgdGFyZ2V0SXJpKTtcbiAgICB9XG5cbiAgICBpZiAobWF0cml4KSB7XG4gICAgICBjb25zdCBldWxlciA9IG5ldyBFdWxlcigpLmZyb21Sb3RhdGlvbk1hdHJpeChtYXRyaXgsIEV1bGVyLlhZWik7XG4gICAgICBjb25zdCBUID0gbWF0cml4LmdldFRyYW5zbGF0aW9uKCkubWFwKG4gPT4gbiAqIDEwMDApIGFzIFtudW1iZXIsIG51bWJlciwgbnVtYmVyXTtcbiAgICAgIGNvbnN0IFIgPSBldWxlci50b1ZlY3RvcjMoKS5tYXA8bnVtYmVyPih0b0RlZ3JlZXMpIGFzIFtudW1iZXIsIG51bWJlciwgbnVtYmVyXTtcbiAgICAgIGNvbnN0IFMgPSBtYXRyaXguZ2V0U2NhbGUoKS5tYXAobiA9PiBuIDwgMSAmJiBuID4gMC45OTk5OTkgPyAxIDogbikgYXMgW251bWJlciwgbnVtYmVyLCBudW1iZXJdO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAnQGNvbnRleHQnOiAnaHR0cHM6Ly9odWJtYXBjb25zb3J0aXVtLmdpdGh1Yi5pby9odWJtYXAtb250b2xvZ3kvY2NmLWNvbnRleHQuanNvbmxkJyxcbiAgICAgICAgJ0BpZCc6IGBodHRwOi8vcHVybC5vcmcvY2NmLzEuNS8ke3V1aWRWNCgpfV9wbGFjZW1lbnRgLFxuICAgICAgICAnQHR5cGUnOiAnU3BhdGlhbFBsYWNlbWVudCcsXG4gICAgICAgIHNvdXJjZTogc291cmNlWydAaWQnXSxcbiAgICAgICAgdGFyZ2V0OiB0YXJnZXRJcmksXG4gICAgICAgIHBsYWNlbWVudF9kYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICAgICAgeF9zY2FsaW5nOiBTWzBdLFxuICAgICAgICB5X3NjYWxpbmc6IFNbMV0sXG4gICAgICAgIHpfc2NhbGluZzogU1syXSxcbiAgICAgICAgc2NhbGluZ191bml0czogJ3JhdGlvJyxcbiAgICAgICAgeF9yb3RhdGlvbjogUlswXSxcbiAgICAgICAgeV9yb3RhdGlvbjogUlsxXSxcbiAgICAgICAgel9yb3RhdGlvbjogUlsyXSxcbiAgICAgICAgcm90YXRpb25fb3JkZXI6ICdYWVonLFxuICAgICAgICByb3RhdGlvbl91bml0czogJ2RlZ3JlZScsXG4gICAgICAgIHhfdHJhbnNsYXRpb246IFRbMF0sXG4gICAgICAgIHlfdHJhbnNsYXRpb246IFRbMV0sXG4gICAgICAgIHpfdHJhbnNsYXRpb246IFRbMl0sXG4gICAgICAgIHRyYW5zbGF0aW9uX3VuaXRzOiAnbWlsbGltZXRlcidcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG59XG4iXX0=