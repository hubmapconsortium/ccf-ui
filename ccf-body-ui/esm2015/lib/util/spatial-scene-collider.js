import { __awaiter } from "tslib";
import { load } from '@loaders.gl/core';
import { DracoLoader } from '@loaders.gl/draco';
import { GLTFLoader } from '@loaders.gl/gltf';
import { Matrix4 } from '@math.gl/core';
import { AABB, Vec3 } from 'cannon-es';
import { traverseScene } from './scene-traversal';
/* eslint-disable  */
export function doCollisions(scene) {
    return __awaiter(this, void 0, void 0, function* () {
        console.log('Starting Collisioning');
        const sourceBoxes = scene
            .filter(d => !d.scenegraph && d.geometry !== 'wireframe')
            .map(model => {
            const mat = new Matrix4(model.transformMatrix);
            const lowerBound = mat.transformAsPoint([-1, -1, -1], []);
            const upperBound = mat.transformAsPoint([1, 1, 1], []);
            return {
                '@id': model['@id'],
                name: model.tooltip,
                entityId: model.entityId,
                bbox: new AABB({
                    lowerBound: new Vec3(...lowerBound.map((n, i) => Math.min(n, upperBound[i]))),
                    upperBound: new Vec3(...upperBound.map((n, i) => Math.max(n, lowerBound[i])))
                })
            };
        });
        const targetBoxes = [];
        for (const model of scene.filter(d => !!d.scenegraph)) {
            const gltf = yield load(model.scenegraph, GLTFLoader, { DracoLoader, decompress: true, postProcess: true });
            for (const gltfScene of gltf.scenes) {
                traverseScene(gltfScene, new Matrix4(model.transformMatrix), (node, modelMatrix) => {
                    if (node.mesh && node.mesh.primitives && node.mesh.primitives.length > 0) {
                        for (const primitive of node.mesh.primitives) {
                            if (primitive.attributes.POSITION && primitive.attributes.POSITION.min) {
                                const lowerBound = modelMatrix.transformAsPoint(primitive.attributes.POSITION.min, []);
                                const upperBound = modelMatrix.transformAsPoint(primitive.attributes.POSITION.max, []);
                                targetBoxes.push({
                                    '@id': model['@id'],
                                    name: node.name,
                                    entityId: model.entityId,
                                    bbox: new AABB({
                                        lowerBound: new Vec3(...lowerBound.map((n, i) => Math.min(n, upperBound[i]))),
                                        upperBound: new Vec3(...upperBound.map((n, i) => Math.max(n, lowerBound[i])))
                                    }),
                                    gltf
                                });
                            }
                        }
                    }
                    return true;
                });
            }
        }
        const report = [];
        const sad = [];
        for (const src of sourceBoxes) {
            const hits = [];
            for (const target of targetBoxes) {
                if (src.bbox.overlaps(target.bbox)) {
                    hits.push({ '@id': target['@id'], name: target.name });
                }
            }
            if (hits.length > 0) {
                report.push({
                    '@id': src.entityId,
                    name: src.name,
                    hits
                });
            }
            else {
                sad.push(src);
            }
        }
        console.log({ sourceBoxes, targetBoxes, report, sad, maxHits: Math.max(...report.map(r => r.hits.length)) });
        const csvReport = [];
        for (const hit of report) {
            csvReport.push({
                'Tissue ID': hit['@id'],
                'Tissue Name': hit.name,
                'Hit ID': '',
                'Hit Name': ''
            });
            for (const h of hit.hits) {
                csvReport.push({
                    'Tissue ID': hit['@id'],
                    'Tissue Name': hit.name,
                    'Hit ID': h['@id'],
                    'Hit Name': h.name
                });
            }
        }
        console.log(csvReport);
        return report;
    });
}
/* eslint-enable */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BhdGlhbC1zY2VuZS1jb2xsaWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NjZi1ib2R5LXVpL3NyYy9saWIvdXRpbC9zcGF0aWFsLXNjZW5lLWNvbGxpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR3ZDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQVNsRCxxQkFBcUI7QUFDckIsTUFBTSxVQUFnQixZQUFZLENBQUMsS0FBeUI7O1FBQzFELE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUNyQyxNQUFNLFdBQVcsR0FBRyxLQUFLO2FBQ3RCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUMsUUFBUSxLQUFLLFdBQVcsQ0FBQzthQUN4RCxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDWCxNQUFNLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDL0MsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMxRCxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZELE9BQU87Z0JBQ0wsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUM7Z0JBQ25CLElBQUksRUFBRSxLQUFLLENBQUMsT0FBTztnQkFDbkIsUUFBUSxFQUFFLEtBQUssQ0FBQyxRQUFRO2dCQUN4QixJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUM7b0JBQ2IsVUFBVSxFQUFFLElBQUksSUFBSSxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzdFLFVBQVUsRUFBRSxJQUFJLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUM5RSxDQUFDO2FBQ0gsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUwsTUFBTSxXQUFXLEdBQWtGLEVBQUUsQ0FBQztRQUN0RyxLQUFLLE1BQU0sS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ3JELE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFvQixFQUFFLFVBQVUsRUFBRSxFQUFDLFdBQVcsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO1lBQ3BILEtBQUssTUFBTSxTQUFTLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDbkMsYUFBYSxDQUFDLFNBQVMsRUFBRSxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLEVBQUU7b0JBQ2pGLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO3dCQUN4RSxLQUFLLE1BQU0sU0FBUyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFOzRCQUM1QyxJQUFJLFNBQVMsQ0FBQyxVQUFVLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRTtnQ0FDdEUsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztnQ0FDdkYsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztnQ0FDdkYsV0FBVyxDQUFDLElBQUksQ0FBQztvQ0FDZixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQztvQ0FDbkIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO29DQUNmLFFBQVEsRUFBRSxLQUFLLENBQUMsUUFBUTtvQ0FDeEIsSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDO3dDQUNiLFVBQVUsRUFBRSxJQUFJLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dDQUM3RSxVQUFVLEVBQUUsSUFBSSxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztxQ0FDOUUsQ0FBQztvQ0FDRixJQUFJO2lDQUNMLENBQUMsQ0FBQzs2QkFDSjt5QkFDRjtxQkFDRjtvQkFDRCxPQUFPLElBQUksQ0FBQztnQkFDZCxDQUFDLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFFRCxNQUFNLE1BQU0sR0FBZ0IsRUFBRSxDQUFDO1FBQy9CLE1BQU0sR0FBRyxHQUFjLEVBQUUsQ0FBQztRQUMxQixLQUFLLE1BQU0sR0FBRyxJQUFJLFdBQVcsRUFBRTtZQUM3QixNQUFNLElBQUksR0FBb0MsRUFBRSxDQUFDO1lBQ2pELEtBQUssTUFBTSxNQUFNLElBQUksV0FBVyxFQUFFO2dCQUNoQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUMsQ0FBQyxDQUFDO2lCQUN0RDthQUNGO1lBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDbkIsTUFBTSxDQUFDLElBQUksQ0FBQztvQkFDVixLQUFLLEVBQUUsR0FBRyxDQUFDLFFBQWtCO29CQUM3QixJQUFJLEVBQUUsR0FBRyxDQUFDLElBQWM7b0JBQ3hCLElBQUk7aUJBQ0wsQ0FBQyxDQUFDO2FBQ0o7aUJBQU07Z0JBQ0wsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNmO1NBQ0Y7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFN0csTUFBTSxTQUFTLEdBQWMsRUFBRSxDQUFDO1FBQ2hDLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxFQUFFO1lBQ3hCLFNBQVMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2IsV0FBVyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUM7Z0JBQ3ZCLGFBQWEsRUFBRSxHQUFHLENBQUMsSUFBSTtnQkFDdkIsUUFBUSxFQUFFLEVBQUU7Z0JBQ1osVUFBVSxFQUFFLEVBQUU7YUFDZixDQUFDLENBQUM7WUFDSCxLQUFLLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEVBQUU7Z0JBQ3hCLFNBQVMsQ0FBQyxJQUFJLENBQUM7b0JBQ2IsV0FBVyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUM7b0JBQ3ZCLGFBQWEsRUFBRSxHQUFHLENBQUMsSUFBSTtvQkFDdkIsUUFBUSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUM7b0JBQ2xCLFVBQVUsRUFBRSxDQUFDLENBQUMsSUFBSTtpQkFDbkIsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtRQUNELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFdkIsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUFBO0FBQ0QsbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbG9hZCB9IGZyb20gJ0Bsb2FkZXJzLmdsL2NvcmUnO1xuaW1wb3J0IHsgRHJhY29Mb2FkZXIgfSBmcm9tICdAbG9hZGVycy5nbC9kcmFjbyc7XG5pbXBvcnQgeyBHTFRGTG9hZGVyIH0gZnJvbSAnQGxvYWRlcnMuZ2wvZ2x0Zic7XG5pbXBvcnQgeyBNYXRyaXg0IH0gZnJvbSAnQG1hdGguZ2wvY29yZSc7XG5pbXBvcnQgeyBBQUJCLCBWZWMzIH0gZnJvbSAnY2Fubm9uLWVzJztcblxuaW1wb3J0IHsgU3BhdGlhbFNjZW5lTm9kZSB9IGZyb20gJy4uL3NoYXJlZC9zcGF0aWFsLXNjZW5lLW5vZGUnO1xuaW1wb3J0IHsgdHJhdmVyc2VTY2VuZSB9IGZyb20gJy4vc2NlbmUtdHJhdmVyc2FsJztcblxuXG5pbnRlcmZhY2UgQ29sbGlzaW9uIHtcbiAgJ0BpZCc6IHN0cmluZztcbiAgbmFtZTogc3RyaW5nO1xuICBoaXRzOiB7ICdAaWQnOiBzdHJpbmc7IG5hbWU6IHN0cmluZyB9W107XG59XG5cbi8qIGVzbGludC1kaXNhYmxlICAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRvQ29sbGlzaW9ucyhzY2VuZTogU3BhdGlhbFNjZW5lTm9kZVtdKTogUHJvbWlzZTxDb2xsaXNpb25bXT4ge1xuICBjb25zb2xlLmxvZygnU3RhcnRpbmcgQ29sbGlzaW9uaW5nJyk7XG4gIGNvbnN0IHNvdXJjZUJveGVzID0gc2NlbmVcbiAgICAuZmlsdGVyKGQgPT4gIWQuc2NlbmVncmFwaCAmJiBkLmdlb21ldHJ5ICE9PSAnd2lyZWZyYW1lJylcbiAgICAubWFwKG1vZGVsID0+IHtcbiAgICAgIGNvbnN0IG1hdCA9IG5ldyBNYXRyaXg0KG1vZGVsLnRyYW5zZm9ybU1hdHJpeCk7XG4gICAgICBjb25zdCBsb3dlckJvdW5kID0gbWF0LnRyYW5zZm9ybUFzUG9pbnQoWy0xLCAtMSwgLTFdLCBbXSk7XG4gICAgICBjb25zdCB1cHBlckJvdW5kID0gbWF0LnRyYW5zZm9ybUFzUG9pbnQoWzEsIDEsIDFdLCBbXSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAnQGlkJzogbW9kZWxbJ0BpZCddLFxuICAgICAgICBuYW1lOiBtb2RlbC50b29sdGlwLFxuICAgICAgICBlbnRpdHlJZDogbW9kZWwuZW50aXR5SWQsXG4gICAgICAgIGJib3g6IG5ldyBBQUJCKHtcbiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMyguLi5sb3dlckJvdW5kLm1hcCgobiwgaSkgPT4gTWF0aC5taW4obiwgdXBwZXJCb3VuZFtpXSkpKSxcbiAgICAgICAgICB1cHBlckJvdW5kOiBuZXcgVmVjMyguLi51cHBlckJvdW5kLm1hcCgobiwgaSkgPT4gTWF0aC5tYXgobiwgbG93ZXJCb3VuZFtpXSkpKVxuICAgICAgICB9KVxuICAgICAgfTtcbiAgICB9KTtcblxuICBjb25zdCB0YXJnZXRCb3hlczogeydAaWQnOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZW50aXR5SWQ/OiBzdHJpbmc7IGJib3g6IEFBQkIsIGdsdGY6IHVua25vd259W10gPSBbXTtcbiAgZm9yIChjb25zdCBtb2RlbCBvZiBzY2VuZS5maWx0ZXIoZCA9PiAhIWQuc2NlbmVncmFwaCkpIHtcbiAgICBjb25zdCBnbHRmID0gYXdhaXQgbG9hZChtb2RlbC5zY2VuZWdyYXBoIGFzIHN0cmluZywgR0xURkxvYWRlciwge0RyYWNvTG9hZGVyLCBkZWNvbXByZXNzOiB0cnVlLCBwb3N0UHJvY2VzczogdHJ1ZX0pO1xuICAgIGZvciAoY29uc3QgZ2x0ZlNjZW5lIG9mIGdsdGYuc2NlbmVzKSB7XG4gICAgICB0cmF2ZXJzZVNjZW5lKGdsdGZTY2VuZSwgbmV3IE1hdHJpeDQobW9kZWwudHJhbnNmb3JtTWF0cml4KSwgKG5vZGUsIG1vZGVsTWF0cml4KSA9PiB7XG4gICAgICAgIGlmIChub2RlLm1lc2ggJiYgbm9kZS5tZXNoLnByaW1pdGl2ZXMgJiYgbm9kZS5tZXNoLnByaW1pdGl2ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGZvciAoY29uc3QgcHJpbWl0aXZlIG9mIG5vZGUubWVzaC5wcmltaXRpdmVzKSB7XG4gICAgICAgICAgICBpZiAocHJpbWl0aXZlLmF0dHJpYnV0ZXMuUE9TSVRJT04gJiYgcHJpbWl0aXZlLmF0dHJpYnV0ZXMuUE9TSVRJT04ubWluKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGxvd2VyQm91bmQgPSBtb2RlbE1hdHJpeC50cmFuc2Zvcm1Bc1BvaW50KHByaW1pdGl2ZS5hdHRyaWJ1dGVzLlBPU0lUSU9OLm1pbiwgW10pO1xuICAgICAgICAgICAgICBjb25zdCB1cHBlckJvdW5kID0gbW9kZWxNYXRyaXgudHJhbnNmb3JtQXNQb2ludChwcmltaXRpdmUuYXR0cmlidXRlcy5QT1NJVElPTi5tYXgsIFtdKTtcbiAgICAgICAgICAgICAgdGFyZ2V0Qm94ZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgJ0BpZCc6IG1vZGVsWydAaWQnXSxcbiAgICAgICAgICAgICAgICBuYW1lOiBub2RlLm5hbWUsXG4gICAgICAgICAgICAgICAgZW50aXR5SWQ6IG1vZGVsLmVudGl0eUlkLFxuICAgICAgICAgICAgICAgIGJib3g6IG5ldyBBQUJCKHtcbiAgICAgICAgICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKC4uLmxvd2VyQm91bmQubWFwKChuLCBpKSA9PiBNYXRoLm1pbihuLCB1cHBlckJvdW5kW2ldKSkpLFxuICAgICAgICAgICAgICAgICAgdXBwZXJCb3VuZDogbmV3IFZlYzMoLi4udXBwZXJCb3VuZC5tYXAoKG4sIGkpID0+IE1hdGgubWF4KG4sIGxvd2VyQm91bmRbaV0pKSlcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBnbHRmXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHJlcG9ydDogQ29sbGlzaW9uW10gPSBbXTtcbiAgY29uc3Qgc2FkOiB1bmtub3duW10gPSBbXTtcbiAgZm9yIChjb25zdCBzcmMgb2Ygc291cmNlQm94ZXMpIHtcbiAgICBjb25zdCBoaXRzOiB7J0BpZCc6IHN0cmluZywgbmFtZTogc3RyaW5nfVtdID0gW107XG4gICAgZm9yIChjb25zdCB0YXJnZXQgb2YgdGFyZ2V0Qm94ZXMpIHtcbiAgICAgIGlmIChzcmMuYmJveC5vdmVybGFwcyh0YXJnZXQuYmJveCkpIHtcbiAgICAgICAgaGl0cy5wdXNoKHsnQGlkJzogdGFyZ2V0WydAaWQnXSwgbmFtZTogdGFyZ2V0Lm5hbWV9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGhpdHMubGVuZ3RoID4gMCkge1xuICAgICAgcmVwb3J0LnB1c2goe1xuICAgICAgICAnQGlkJzogc3JjLmVudGl0eUlkIGFzIHN0cmluZyxcbiAgICAgICAgbmFtZTogc3JjLm5hbWUgYXMgc3RyaW5nLFxuICAgICAgICBoaXRzXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2FkLnB1c2goc3JjKTtcbiAgICB9XG4gIH1cblxuICBjb25zb2xlLmxvZyh7IHNvdXJjZUJveGVzLCB0YXJnZXRCb3hlcywgcmVwb3J0LCBzYWQsIG1heEhpdHM6IE1hdGgubWF4KC4uLnJlcG9ydC5tYXAociA9PiByLmhpdHMubGVuZ3RoKSkgfSk7XG5cbiAgY29uc3QgY3N2UmVwb3J0OiB1bmtub3duW10gPSBbXTtcbiAgZm9yIChjb25zdCBoaXQgb2YgcmVwb3J0KSB7XG4gICAgY3N2UmVwb3J0LnB1c2goe1xuICAgICAgJ1Rpc3N1ZSBJRCc6IGhpdFsnQGlkJ10sXG4gICAgICAnVGlzc3VlIE5hbWUnOiBoaXQubmFtZSxcbiAgICAgICdIaXQgSUQnOiAnJyxcbiAgICAgICdIaXQgTmFtZSc6ICcnXG4gICAgfSk7XG4gICAgZm9yIChjb25zdCBoIG9mIGhpdC5oaXRzKSB7XG4gICAgICBjc3ZSZXBvcnQucHVzaCh7XG4gICAgICAgICdUaXNzdWUgSUQnOiBoaXRbJ0BpZCddLFxuICAgICAgICAnVGlzc3VlIE5hbWUnOiBoaXQubmFtZSxcbiAgICAgICAgJ0hpdCBJRCc6IGhbJ0BpZCddLFxuICAgICAgICAnSGl0IE5hbWUnOiBoLm5hbWVcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICBjb25zb2xlLmxvZyhjc3ZSZXBvcnQpO1xuXG4gIHJldHVybiByZXBvcnQ7XG59XG4vKiBlc2xpbnQtZW5hYmxlICovXG4iXX0=