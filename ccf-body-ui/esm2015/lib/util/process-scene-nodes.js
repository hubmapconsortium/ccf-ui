import { __awaiter } from "tslib";
import { Matrix4 } from '@math.gl/core';
import { AABB, Vec3 } from 'cannon-es';
import { loadGLTF, registerGLTFLoaders } from './load-gltf';
import { traverseScene } from './scene-traversal';
/* eslint-disable  */
function childNames(scene, names = []) {
    for (const child of (scene.nodes || scene.children || [])) {
        names.push(child.name);
        childNames(child, names);
    }
    return names;
}
export function processSceneNodes(gltfUrl, worldMatrix, scenegraphNode) {
    return __awaiter(this, void 0, void 0, function* () {
        registerGLTFLoaders();
        const gltf = yield loadGLTF({ scenegraph: gltfUrl, scenegraphNode });
        const nodes = {};
        const gltfNodes = [];
        for (const scene of gltf.scenes) {
            worldMatrix = new Matrix4(worldMatrix || Matrix4.IDENTITY);
            traverseScene(scene, worldMatrix, (node, modelMatrix) => {
                const processedNode = {
                    '@id': (node.name || node.id),
                    '@type': 'ProcessedNode',
                    transformMatrix: new Matrix4(modelMatrix),
                    geometry: 'wireframe',
                    node
                };
                gltfNodes.push({
                    '@id': `GLTF:${processedNode['@id']}`,
                    '@type': 'GLTFNode',
                    scenegraph: gltfUrl,
                    scenegraphNode: processedNode['@id'],
                    transformMatrix: new Matrix4(worldMatrix || Matrix4.IDENTITY),
                    tooltip: (node.name || node.id),
                    color: [255, 255, 255, 255],
                    _lighting: 'pbr',
                    zoomBasedOpacity: true,
                    node
                });
                if (node.mesh && node.mesh.primitives && node.mesh.primitives.length > 0) {
                    for (const primitive of node.mesh.primitives) {
                        if (primitive.attributes.POSITION && primitive.attributes.POSITION.min) {
                            const lowerBound = modelMatrix.transformAsPoint(primitive.attributes.POSITION.min, []);
                            const upperBound = modelMatrix.transformAsPoint(primitive.attributes.POSITION.max, []);
                            processedNode.bbox = new AABB({
                                lowerBound: new Vec3(...lowerBound.map((n, i) => Math.min(n, upperBound[i]))),
                                upperBound: new Vec3(...upperBound.map((n, i) => Math.max(n, lowerBound[i])))
                            });
                        }
                    }
                }
                nodes[processedNode['@id']] = processedNode;
                return true;
            });
        }
        for (const node of Object.values(nodes).filter(n => !n.bbox)) {
            for (const child of childNames(node.node).map(n => nodes[n]).filter(n => n.bbox)) {
                if (!node.bbox) {
                    node.bbox = child.bbox.clone();
                }
                else {
                    node.bbox.extend(child.bbox);
                }
            }
            if (!node.bbox) {
                delete nodes[node['@id']];
            }
        }
        for (const node of Object.values(nodes)) {
            const lb = node.bbox.lowerBound;
            const ub = node.bbox.upperBound;
            const size = node.size = ub.clone().vsub(lb);
            const halfSize = size.clone().vmul(new Vec3(0.5, 0.5, 0.5));
            const center = node.center = lb.clone().vadd(halfSize);
            node.transformMatrix = new Matrix4(Matrix4.IDENTITY)
                .translate(center.toArray())
                .scale(halfSize.toArray());
        }
        for (const node of gltfNodes) {
            nodes[node['@id']] = node;
        }
        return nodes;
    });
}
/* eslint-enable */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1zY2VuZS1ub2Rlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NjZi1ib2R5LXVpL3NyYy9saWIvdXRpbC9wcm9jZXNzLXNjZW5lLW5vZGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXZDLE9BQU8sRUFBRSxRQUFRLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBWWxELHFCQUFxQjtBQUNyQixTQUFTLFVBQVUsQ0FBQyxLQUFLLEVBQUUsUUFBa0IsRUFBRTtJQUM3QyxLQUFLLE1BQU0sS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxFQUFFO1FBQ3pELEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZCLFVBQVUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDMUI7SUFDRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFFRCxNQUFNLFVBQWdCLGlCQUFpQixDQUFDLE9BQWUsRUFBRSxXQUFxQixFQUFFLGNBQXVCOztRQUVyRyxtQkFBbUIsRUFBRSxDQUFDO1FBQ3RCLE1BQU0sSUFBSSxHQUFHLE1BQU0sUUFBUSxDQUFDLEVBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQXFCLENBQUMsQ0FBQztRQUN2RixNQUFNLEtBQUssR0FBb0MsRUFBRSxDQUFDO1FBQ2xELE1BQU0sU0FBUyxHQUFvQixFQUFFLENBQUM7UUFDdEMsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lB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QUFRLENBQUMsQ0FBQztZQUV2RCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7aUJBQ2pELFNBQVMsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7aUJBQzNCLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztTQUM5QjtRQUNELEtBQUssTUFBTSxJQUFJLElBQUksU0FBUyxFQUFFO1lBQzVCLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDM0I7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FBQTtBQUNELG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1hdHJpeDQgfSBmcm9tICdAbWF0aC5nbC9jb3JlJztcbmltcG9ydCB7IEFBQkIsIFZlYzMgfSBmcm9tICdjYW5ub24tZXMnO1xuXG5pbXBvcnQgeyBsb2FkR0xURiwgcmVnaXN0ZXJHTFRGTG9hZGVycyB9IGZyb20gJy4vbG9hZC1nbHRmJztcbmltcG9ydCB7IHRyYXZlcnNlU2NlbmUgfSBmcm9tICcuL3NjZW5lLXRyYXZlcnNhbCc7XG5pbXBvcnQgeyBTcGF0aWFsU2NlbmVOb2RlIH0gZnJvbSAnLi4vc2hhcmVkL3NwYXRpYWwtc2NlbmUtbm9kZSc7XG5cblxuZXhwb3J0IGludGVyZmFjZSBQcm9jZXNzZWROb2RlIGV4dGVuZHMgU3BhdGlhbFNjZW5lTm9kZSB7XG4gIGJib3g6IEFBQkI7XG4gIGpzb25sZDogdW5rbm93bjtcbiAgbm9kZTogdW5rbm93bjtcbiAgc2l6ZTogVmVjMztcbiAgY2VudGVyOiBWZWMzO1xufVxuXG4vKiBlc2xpbnQtZGlzYWJsZSAgKi9cbmZ1bmN0aW9uIGNoaWxkTmFtZXMoc2NlbmUsIG5hbWVzOiBzdHJpbmdbXSA9IFtdKTogc3RyaW5nW10ge1xuICBmb3IgKGNvbnN0IGNoaWxkIG9mIChzY2VuZS5ub2RlcyB8fCBzY2VuZS5jaGlsZHJlbiB8fCBbXSkpIHtcbiAgICBuYW1lcy5wdXNoKGNoaWxkLm5hbWUpO1xuICAgIGNoaWxkTmFtZXMoY2hpbGQsIG5hbWVzKTtcbiAgfVxuICByZXR1cm4gbmFtZXM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcm9jZXNzU2NlbmVOb2RlcyhnbHRmVXJsOiBzdHJpbmcsIHdvcmxkTWF0cml4PzogTWF0cml4NCwgc2NlbmVncmFwaE5vZGU/OiBzdHJpbmdcbiAgICApOiBQcm9taXNlPHsgW25vZGU6IHN0cmluZ106IFByb2Nlc3NlZE5vZGV9PiB7XG4gIHJlZ2lzdGVyR0xURkxvYWRlcnMoKTtcbiAgY29uc3QgZ2x0ZiA9IGF3YWl0IGxvYWRHTFRGKHtzY2VuZWdyYXBoOiBnbHRmVXJsLCBzY2VuZWdyYXBoTm9kZX0gYXMgU3BhdGlhbFNjZW5lTm9kZSk7XG4gIGNvbnN0IG5vZGVzOiB7W25vZGU6IHN0cmluZ106IFByb2Nlc3NlZE5vZGV9ID0ge307XG4gIGNvbnN0IGdsdGZOb2RlczogUHJvY2Vzc2VkTm9kZVtdID0gW107XG4gIGZvciAoY29uc3Qgc2NlbmUgb2YgZ2x0Zi5zY2VuZXMpIHtcbiAgICB3b3JsZE1hdHJpeCA9IG5ldyBNYXRyaXg0KHdvcmxkTWF0cml4IHx8IE1hdHJpeDQuSURFTlRJVFkpO1xuICAgIHRyYXZlcnNlU2NlbmUoc2NlbmUsIHdvcmxkTWF0cml4LCAobm9kZSwgbW9kZWxNYXRyaXg6IE1hdHJpeDQpID0+IHtcbiAgICAgIGNvbnN0IHByb2Nlc3NlZE5vZGU6IFByb2Nlc3NlZE5vZGUgPSB7XG4gICAgICAgICdAaWQnOiAobm9kZS5uYW1lIHx8IG5vZGUuaWQpIGFzIHN0cmluZyxcbiAgICAgICAgJ0B0eXBlJzogJ1Byb2Nlc3NlZE5vZGUnLFxuICAgICAgICB0cmFuc2Zvcm1NYXRyaXg6IG5ldyBNYXRyaXg0KG1vZGVsTWF0cml4KSxcbiAgICAgICAgZ2VvbWV0cnk6ICd3aXJlZnJhbWUnLFxuICAgICAgICBub2RlXG4gICAgICB9IGFzIFByb2Nlc3NlZE5vZGU7XG4gICAgICBnbHRmTm9kZXMucHVzaCh7XG4gICAgICAgICdAaWQnOiBgR0xURjoke3Byb2Nlc3NlZE5vZGVbJ0BpZCddfWAsXG4gICAgICAgICdAdHlwZSc6ICdHTFRGTm9kZScsXG4gICAgICAgIHNjZW5lZ3JhcGg6IGdsdGZVcmwsXG4gICAgICAgIHNjZW5lZ3JhcGhOb2RlOiBwcm9jZXNzZWROb2RlWydAaWQnXSxcbiAgICAgICAgdHJhbnNmb3JtTWF0cml4OiBuZXcgTWF0cml4NCh3b3JsZE1hdHJpeCB8fCBNYXRyaXg0LklERU5USVRZKSxcbiAgICAgICAgdG9vbHRpcDogKG5vZGUubmFtZSB8fCBub2RlLmlkKSBhcyBzdHJpbmcsXG4gICAgICAgIGNvbG9yOiBbMjU1LCAyNTUsIDI1NSwgMjU1XSxcbiAgICAgICAgX2xpZ2h0aW5nOiAncGJyJyxcbiAgICAgICAgem9vbUJhc2VkT3BhY2l0eTogdHJ1ZSxcbiAgICAgICAgbm9kZVxuICAgICAgfSBhcyBQcm9jZXNzZWROb2RlKTtcbiAgICAgIGlmIChub2RlLm1lc2ggJiYgbm9kZS5tZXNoLnByaW1pdGl2ZXMgJiYgbm9kZS5tZXNoLnByaW1pdGl2ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBmb3IgKGNvbnN0IHByaW1pdGl2ZSBvZiBub2RlLm1lc2gucHJpbWl0aXZlcykge1xuICAgICAgICAgIGlmIChwcmltaXRpdmUuYXR0cmlidXRlcy5QT1NJVElPTiAmJiBwcmltaXRpdmUuYXR0cmlidXRlcy5QT1NJVElPTi5taW4pIHtcbiAgICAgICAgICAgIGNvbnN0IGxvd2VyQm91bmQgPSBtb2RlbE1hdHJpeC50cmFuc2Zvcm1Bc1BvaW50KHByaW1pdGl2ZS5hdHRyaWJ1dGVzLlBPU0lUSU9OLm1pbiwgW10pO1xuICAgICAgICAgICAgY29uc3QgdXBwZXJCb3VuZCA9IG1vZGVsTWF0cml4LnRyYW5zZm9ybUFzUG9pbnQocHJpbWl0aXZlLmF0dHJpYnV0ZXMuUE9TSVRJT04ubWF4LCBbXSk7XG4gICAgICAgICAgICBwcm9jZXNzZWROb2RlLmJib3ggPSBuZXcgQUFCQih7XG4gICAgICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKC4uLmxvd2VyQm91bmQubWFwKChuLCBpKSA9PiBNYXRoLm1pbihuLCB1cHBlckJvdW5kW2ldKSkpLFxuICAgICAgICAgICAgICB1cHBlckJvdW5kOiBuZXcgVmVjMyguLi51cHBlckJvdW5kLm1hcCgobiwgaSkgPT4gTWF0aC5tYXgobiwgbG93ZXJCb3VuZFtpXSkpKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBub2Rlc1twcm9jZXNzZWROb2RlWydAaWQnXV0gPSBwcm9jZXNzZWROb2RlO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSk7XG4gIH1cblxuICBmb3IgKGNvbnN0IG5vZGUgb2YgT2JqZWN0LnZhbHVlcyhub2RlcykuZmlsdGVyKG4gPT4gIW4uYmJveCkpIHtcbiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIGNoaWxkTmFtZXMobm9kZS5ub2RlKS5tYXAobiA9PiBub2Rlc1tuXSkuZmlsdGVyKG4gPT4gbi5iYm94KSkge1xuICAgICAgaWYgKCFub2RlLmJib3gpIHtcbiAgICAgICAgbm9kZS5iYm94ID0gY2hpbGQuYmJveC5jbG9uZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbm9kZS5iYm94LmV4dGVuZChjaGlsZC5iYm94KTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFub2RlLmJib3gpIHtcbiAgICAgIGRlbGV0ZSBub2Rlc1tub2RlWydAaWQnXV07XG4gICAgfVxuICB9XG4gIGZvciAoY29uc3Qgbm9kZSBvZiBPYmplY3QudmFsdWVzKG5vZGVzKSkge1xuICAgIGNvbnN0IGxiID0gbm9kZS5iYm94Lmxvd2VyQm91bmQ7XG4gICAgY29uc3QgdWIgPSBub2RlLmJib3gudXBwZXJCb3VuZDtcbiAgICBjb25zdCBzaXplID0gbm9kZS5zaXplID0gdWIuY2xvbmUoKS52c3ViKGxiKTtcbiAgICBjb25zdCBoYWxmU2l6ZSA9IHNpemUuY2xvbmUoKS52bXVsKG5ldyBWZWMzKDAuNSwgMC41LCAwLjUpKTtcbiAgICBjb25zdCBjZW50ZXIgPSBub2RlLmNlbnRlciA9IGxiLmNsb25lKCkudmFkZChoYWxmU2l6ZSk7XG5cbiAgICBub2RlLnRyYW5zZm9ybU1hdHJpeCA9IG5ldyBNYXRyaXg0KE1hdHJpeDQuSURFTlRJVFkpXG4gICAgICAudHJhbnNsYXRlKGNlbnRlci50b0FycmF5KCkpXG4gICAgICAuc2NhbGUoaGFsZlNpemUudG9BcnJheSgpKTtcbiAgfVxuICBmb3IgKGNvbnN0IG5vZGUgb2YgZ2x0Zk5vZGVzKSB7XG4gICAgbm9kZXNbbm9kZVsnQGlkJ11dID0gbm9kZTtcbiAgfVxuICByZXR1cm4gbm9kZXM7XG59XG4vKiBlc2xpbnQtZW5hYmxlICovXG4iXX0=