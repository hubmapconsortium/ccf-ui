import { __awaiter } from "tslib";
import { Matrix4 } from '@math.gl/core';
import { AABB, Vec3 } from 'cannon-es';
import { loadGLTF } from './load-gltf';
import { traverseScene } from './scene-traversal';
export function simplifyScene(nodes) {
    return __awaiter(this, void 0, void 0, function* () {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const gltfCache = {};
        const gltfUrls = new Set(nodes.map(n => n.scenegraph).filter(n => !!n));
        for (const gltfUrl of gltfUrls) {
            // eslint-disable-next-line no-await-in-loop
            gltfCache[gltfUrl] = yield loadGLTF({ scenegraph: gltfUrl });
        }
        const newNodes = nodes.filter(n => !n.scenegraph);
        for (const model of nodes.filter(n => n.scenegraph)) {
            const gltf = gltfCache[model.scenegraph];
            const bbox = new AABB();
            let worldMatrix = new Matrix4(model.transformMatrix);
            /* eslint-disable  */
            if (model.scenegraphNode) {
                const scenegraphNode = model.scenegraphNode ? gltf.nodes.find((n) => n.name === model.scenegraphNode) : undefined;
                let foundNodeInScene = false;
                for (const scene of gltf.scenes) {
                    if (!foundNodeInScene) {
                        traverseScene(scene, new Matrix4(model.transformMatrix), (child, modelMatrix) => {
                            if (child === scenegraphNode) {
                                worldMatrix = modelMatrix;
                                foundNodeInScene = true;
                                return false;
                            }
                            return true;
                        });
                    }
                }
                gltf.scene = {
                    id: model.scenegraphNode,
                    name: model.scenegraphNode,
                    nodes: [scenegraphNode]
                };
            }
            traverseScene(gltf.scene, worldMatrix, (node, modelMatrix) => {
                if (node.mesh && node.mesh.primitives && node.mesh.primitives.length > 0) {
                    for (const primitive of node.mesh.primitives) {
                        if (primitive.attributes.POSITION && primitive.attributes.POSITION.min) {
                            const lowerBound = modelMatrix.transformAsPoint(primitive.attributes.POSITION.min, []);
                            const upperBound = modelMatrix.transformAsPoint(primitive.attributes.POSITION.max, []);
                            const innerBbox = new AABB({
                                lowerBound: new Vec3(...lowerBound.map((n, i) => Math.min(n, upperBound[i]))),
                                upperBound: new Vec3(...upperBound.map((n, i) => Math.max(n, lowerBound[i])))
                            });
                            bbox.extend(innerBbox);
                        }
                    }
                }
                return true;
            });
            /* eslint-enable */
            const size = bbox.upperBound.clone().vsub(bbox.lowerBound);
            const halfSize = size.clone().vmul(new Vec3(0.5, 0.5, 0.5));
            const position = bbox.lowerBound.clone().vadd(halfSize);
            const transformMatrix = new Matrix4(Matrix4.IDENTITY)
                .translate(position.toArray())
                .scale(halfSize.toArray());
            const newNode = Object.assign(Object.assign({}, model), { transformMatrix, geometry: 'wireframe' });
            delete newNode.scenegraph;
            delete newNode.scenegraphNode;
            newNodes.push(newNode);
        }
        return newNodes;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltcGxpZnktc2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jY2YtYm9keS11aS9zcmMvbGliL3V0aWwvc2ltcGxpZnktc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHdkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN2QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFHbEQsTUFBTSxVQUFnQixhQUFhLENBQUMsS0FBeUI7O1FBQzNELDhEQUE4RDtRQUM5RCxNQUFNLFNBQVMsR0FBMkIsRUFBRSxDQUFDO1FBQzdDLE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEUsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7WUFDOUIsNENBQTRDO1lBQzVDLFNBQVMsQ0FBQyxPQUFpQixDQUFDLEdBQUcsTUFBTSxRQUFRLENBQUMsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFzQixDQUFDLENBQUM7U0FDNUY7UUFDRCxNQUFNLFFBQVEsR0FBdUIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXRFLEtBQUssTUFBTSxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNuRCxNQUFNLElBQUksR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLFVBQW9CLENBQUMsQ0FBQztZQUNuRCxNQUFNLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ3hCLElBQUksV0FBVyxHQUFHLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUVyRCxxQkFBcUI7WUFDckIsSUFBSSxLQUFLLENBQUMsY0FBYyxFQUFFO2dCQUN4QixNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztnQkFDbEgsSUFBSSxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7Z0JBQzdCLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtvQkFDL0IsSUFBSSxDQUFDLGdCQUFnQixFQUFFO3dCQUNyQixhQUFhLENBQUMsS0FBSyxFQUFFLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUUsRUFBRTs0QkFDOUUsSUFBSSxLQUFLLEtBQUssY0FBYyxFQUFFO2dDQUM1QixXQUFXLEdBQUcsV0FBVyxDQUFDO2dDQUMxQixnQkFBZ0IsR0FBRyxJQUFJLENBQUM7Z0NBQ3hCLE9BQU8sS0FBSyxDQUFDOzZCQUNkOzRCQUNELE9BQU8sSUFBSSxDQUFDO3dCQUNkLENBQUMsQ0FBQyxDQUFDO3FCQUNKO2lCQUNGO2dCQUNELElBQUksQ0FBQyxLQUFLLEdBQUc7b0JBQ1gsRUFBRSxFQUFFLEtBQUssQ0FBQyxjQUFjO29CQUN4QixJQUFJLEVBQUUsS0FBSyxDQUFDLGNBQWM7b0JBQzFCLEtBQUssRUFBRSxDQUFDLGNBQWMsQ0FBQztpQkFDeEIsQ0FBQzthQUNIO1lBRUQsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxFQUFFO2dCQUMzRCxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDeEUsS0FBSyxNQUFNLFNBQVMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTt3QkFDNUMsSUFBSSxTQUFTLENBQUMsVUFBVSxDQUFDLFFBQVEsSUFBSSxTQUFTLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUU7NEJBQ3RFLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7NEJBQ3ZGLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7NEJBQ3ZGLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDO2dDQUN6QixVQUFVLEVBQUUsSUFBSSxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQ0FDN0UsVUFBVSxFQUFFLElBQUksSUFBSSxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7NkJBQzlFLENBQUMsQ0FBQzs0QkFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO3lCQUN4QjtxQkFDRjtpQkFDRjtnQkFDRCxPQUFPLElBQUksQ0FBQztZQUNkLENBQUMsQ0FBQyxDQUFDO1lBQ0gsbUJBQW1CO1lBRW5CLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMzRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUM1RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN4RCxNQUFNLGVBQWUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDO2lCQUNsRCxTQUFTLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO2lCQUM3QixLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDN0IsTUFBTSxPQUFPLG1DQUNSLEtBQUssS0FDUixlQUFlLEVBQ2YsUUFBUSxFQUFFLFdBQVcsR0FDdEIsQ0FBQztZQUNGLE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQztZQUMxQixPQUFPLE9BQU8sQ0FBQyxjQUFjLENBQUM7WUFFOUIsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN4QjtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7Q0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1hdHJpeDQgfSBmcm9tICdAbWF0aC5nbC9jb3JlJztcbmltcG9ydCB7IEFBQkIsIFZlYzMgfSBmcm9tICdjYW5ub24tZXMnO1xuXG5pbXBvcnQgeyBTcGF0aWFsU2NlbmVOb2RlIH0gZnJvbSAnLi4vc2hhcmVkL3NwYXRpYWwtc2NlbmUtbm9kZSc7XG5pbXBvcnQgeyBsb2FkR0xURiB9IGZyb20gJy4vbG9hZC1nbHRmJztcbmltcG9ydCB7IHRyYXZlcnNlU2NlbmUgfSBmcm9tICcuL3NjZW5lLXRyYXZlcnNhbCc7XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNpbXBsaWZ5U2NlbmUobm9kZXM6IFNwYXRpYWxTY2VuZU5vZGVbXSk6IFByb21pc2U8U3BhdGlhbFNjZW5lTm9kZVtdPiB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIGNvbnN0IGdsdGZDYWNoZTogeyBbdXJsOiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuICBjb25zdCBnbHRmVXJscyA9IG5ldyBTZXQobm9kZXMubWFwKG4gPT4gbi5zY2VuZWdyYXBoKS5maWx0ZXIobiA9PiAhIW4pKTtcbiAgZm9yIChjb25zdCBnbHRmVXJsIG9mIGdsdGZVcmxzKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWF3YWl0LWluLWxvb3BcbiAgICBnbHRmQ2FjaGVbZ2x0ZlVybCBhcyBzdHJpbmddID0gYXdhaXQgbG9hZEdMVEYoeyBzY2VuZWdyYXBoOiBnbHRmVXJsIH0gYXMgU3BhdGlhbFNjZW5lTm9kZSk7XG4gIH1cbiAgY29uc3QgbmV3Tm9kZXM6IFNwYXRpYWxTY2VuZU5vZGVbXSA9IG5vZGVzLmZpbHRlcihuID0+ICFuLnNjZW5lZ3JhcGgpO1xuXG4gIGZvciAoY29uc3QgbW9kZWwgb2Ygbm9kZXMuZmlsdGVyKG4gPT4gbi5zY2VuZWdyYXBoKSkge1xuICAgIGNvbnN0IGdsdGYgPSBnbHRmQ2FjaGVbbW9kZWwuc2NlbmVncmFwaCBhcyBzdHJpbmddO1xuICAgIGNvbnN0IGJib3ggPSBuZXcgQUFCQigpO1xuICAgIGxldCB3b3JsZE1hdHJpeCA9IG5ldyBNYXRyaXg0KG1vZGVsLnRyYW5zZm9ybU1hdHJpeCk7XG5cbiAgICAvKiBlc2xpbnQtZGlzYWJsZSAgKi9cbiAgICBpZiAobW9kZWwuc2NlbmVncmFwaE5vZGUpIHtcbiAgICAgIGNvbnN0IHNjZW5lZ3JhcGhOb2RlID0gbW9kZWwuc2NlbmVncmFwaE5vZGUgPyBnbHRmLm5vZGVzLmZpbmQoKG4pID0+IG4ubmFtZSA9PT0gbW9kZWwuc2NlbmVncmFwaE5vZGUpIDogdW5kZWZpbmVkO1xuICAgICAgbGV0IGZvdW5kTm9kZUluU2NlbmUgPSBmYWxzZTtcbiAgICAgIGZvciAoY29uc3Qgc2NlbmUgb2YgZ2x0Zi5zY2VuZXMpIHtcbiAgICAgICAgaWYgKCFmb3VuZE5vZGVJblNjZW5lKSB7XG4gICAgICAgICAgdHJhdmVyc2VTY2VuZShzY2VuZSwgbmV3IE1hdHJpeDQobW9kZWwudHJhbnNmb3JtTWF0cml4KSwgKGNoaWxkLCBtb2RlbE1hdHJpeCkgPT4ge1xuICAgICAgICAgICAgaWYgKGNoaWxkID09PSBzY2VuZWdyYXBoTm9kZSkge1xuICAgICAgICAgICAgICB3b3JsZE1hdHJpeCA9IG1vZGVsTWF0cml4O1xuICAgICAgICAgICAgICBmb3VuZE5vZGVJblNjZW5lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGdsdGYuc2NlbmUgPSB7XG4gICAgICAgIGlkOiBtb2RlbC5zY2VuZWdyYXBoTm9kZSxcbiAgICAgICAgbmFtZTogbW9kZWwuc2NlbmVncmFwaE5vZGUsXG4gICAgICAgIG5vZGVzOiBbc2NlbmVncmFwaE5vZGVdXG4gICAgICB9O1xuICAgIH1cblxuICAgIHRyYXZlcnNlU2NlbmUoZ2x0Zi5zY2VuZSwgd29ybGRNYXRyaXgsIChub2RlLCBtb2RlbE1hdHJpeCkgPT4ge1xuICAgICAgaWYgKG5vZGUubWVzaCAmJiBub2RlLm1lc2gucHJpbWl0aXZlcyAmJiBub2RlLm1lc2gucHJpbWl0aXZlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZvciAoY29uc3QgcHJpbWl0aXZlIG9mIG5vZGUubWVzaC5wcmltaXRpdmVzKSB7XG4gICAgICAgICAgaWYgKHByaW1pdGl2ZS5hdHRyaWJ1dGVzLlBPU0lUSU9OICYmIHByaW1pdGl2ZS5hdHRyaWJ1dGVzLlBPU0lUSU9OLm1pbikge1xuICAgICAgICAgICAgY29uc3QgbG93ZXJCb3VuZCA9IG1vZGVsTWF0cml4LnRyYW5zZm9ybUFzUG9pbnQocHJpbWl0aXZlLmF0dHJpYnV0ZXMuUE9TSVRJT04ubWluLCBbXSk7XG4gICAgICAgICAgICBjb25zdCB1cHBlckJvdW5kID0gbW9kZWxNYXRyaXgudHJhbnNmb3JtQXNQb2ludChwcmltaXRpdmUuYXR0cmlidXRlcy5QT1NJVElPTi5tYXgsIFtdKTtcbiAgICAgICAgICAgIGNvbnN0IGlubmVyQmJveCA9IG5ldyBBQUJCKHtcbiAgICAgICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoLi4ubG93ZXJCb3VuZC5tYXAoKG4sIGkpID0+IE1hdGgubWluKG4sIHVwcGVyQm91bmRbaV0pKSksXG4gICAgICAgICAgICAgIHVwcGVyQm91bmQ6IG5ldyBWZWMzKC4uLnVwcGVyQm91bmQubWFwKChuLCBpKSA9PiBNYXRoLm1heChuLCBsb3dlckJvdW5kW2ldKSkpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJib3guZXh0ZW5kKGlubmVyQmJveCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgICAvKiBlc2xpbnQtZW5hYmxlICovXG5cbiAgICBjb25zdCBzaXplID0gYmJveC51cHBlckJvdW5kLmNsb25lKCkudnN1YihiYm94Lmxvd2VyQm91bmQpO1xuICAgIGNvbnN0IGhhbGZTaXplID0gc2l6ZS5jbG9uZSgpLnZtdWwobmV3IFZlYzMoMC41LCAwLjUsIDAuNSkpO1xuICAgIGNvbnN0IHBvc2l0aW9uID0gYmJveC5sb3dlckJvdW5kLmNsb25lKCkudmFkZChoYWxmU2l6ZSk7XG4gICAgY29uc3QgdHJhbnNmb3JtTWF0cml4ID0gbmV3IE1hdHJpeDQoTWF0cml4NC5JREVOVElUWSlcbiAgICAgIC50cmFuc2xhdGUocG9zaXRpb24udG9BcnJheSgpKVxuICAgICAgLnNjYWxlKGhhbGZTaXplLnRvQXJyYXkoKSk7XG4gICAgY29uc3QgbmV3Tm9kZTogU3BhdGlhbFNjZW5lTm9kZSA9IHtcbiAgICAgIC4uLm1vZGVsLFxuICAgICAgdHJhbnNmb3JtTWF0cml4LFxuICAgICAgZ2VvbWV0cnk6ICd3aXJlZnJhbWUnXG4gICAgfTtcbiAgICBkZWxldGUgbmV3Tm9kZS5zY2VuZWdyYXBoO1xuICAgIGRlbGV0ZSBuZXdOb2RlLnNjZW5lZ3JhcGhOb2RlO1xuXG4gICAgbmV3Tm9kZXMucHVzaChuZXdOb2RlKTtcbiAgfVxuICByZXR1cm4gbmV3Tm9kZXM7XG59XG4iXX0=