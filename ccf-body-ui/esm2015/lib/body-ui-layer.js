/* eslint-disable @typescript-eslint/no-unsafe-call */
import { CompositeLayer, COORDINATE_SYSTEM } from '@deck.gl/core';
import { TextLayer } from '@deck.gl/layers';
import { ScenegraphLayer, SimpleMeshLayer } from '@deck.gl/mesh-layers';
import { ConeGeometry, CubeGeometry, CylinderGeometry, SphereGeometry } from '@luma.gl/core';
import { Matrix4 } from '@math.gl/core';
import { loadGLTF, loadGLTF2, registerGLTFLoaders } from './util/load-gltf';
import { doCollisions } from './util/spatial-scene-collider';
function meshLayer(id, data, options) {
    if (!data || data.length === 0) {
        return undefined;
    }
    else {
        let mesh;
        switch (options.geometry) {
            case 'sphere':
                mesh = new SphereGeometry();
                break;
            case 'cone':
                mesh = new ConeGeometry();
                break;
            case 'cylinder':
                mesh = new CylinderGeometry();
                break;
            case 'cube':
            default:
                mesh = new CubeGeometry();
                break;
        }
        return new SimpleMeshLayer(Object.assign({
            id,
            pickable: true,
            autoHighlight: false,
            highlightColor: [30, 136, 229, 255],
            coordinateSystem: COORDINATE_SYSTEM.CARTESIAN,
            data,
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            mesh: mesh,
            wireframe: false,
            getTransformMatrix: (d) => d.transformMatrix,
            getColor: (d) => d.color || [255, 255, 255, 0.9 * 255]
        }, options));
    }
}
function textLayer(id, data, options) {
    if (!data || data.length === 0) {
        return undefined;
    }
    else {
        return new TextLayer(Object.assign({
            id,
            pickable: true,
            data: data.map(d => (Object.assign(Object.assign({}, d), { position: new Matrix4(d.transformMatrix).getTranslation() }))),
            getText: (d) => d.text,
            getPosition: (d) => d.position,
            getColor: (d) => d.color
        }, options));
    }
}
export class BodyUILayer extends CompositeLayer {
    initializeState() {
        const { data } = this.props;
        this.setState({ data: data !== null && data !== void 0 ? data : [], zoomOpacity: 0.8, doCollisions: false });
        registerGLTFLoaders();
    }
    renderLayers() {
        var _a, _b;
        const state = this.state;
        const geometries = {
            'sphere': [], 'cone': [], 'cylinder': [], 'cube': [], 'text': [], 'wireframe': [], 'scenegraph': []
        };
        for (const node of state.data) {
            const geometry = (_a = node.geometry) !== null && _a !== void 0 ? _a : 'cube';
            if (node.scenegraph) {
                geometries.scenegraph.push(node);
            }
            else if (geometries[geometry] !== undefined) {
                geometries[geometry].push(node);
            }
        }
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const url2gltf = {};
        for (const m of geometries.scenegraph) {
            if (m.scenegraph && m.scenegraphNode && !Object.prototype.hasOwnProperty.call(url2gltf, m.scenegraph)) {
                url2gltf[m.scenegraph] = loadGLTF({ scenegraph: m.scenegraph }, BodyUILayer.gltfCache);
            }
        }
        const layers = [];
        for (const [geometry, nodes] of Object.entries(geometries)) {
            if (geometry === 'scenegraph') {
                for (const model of nodes) {
                    layers.push(new ScenegraphLayer({
                        id: 'models-' + model['@id'],
                        opacity: model.zoomBasedOpacity ? state.zoomOpacity : (model.opacity !== undefined ? model.opacity : 1.0),
                        pickable: !model.unpickable,
                        coordinateSystem: COORDINATE_SYSTEM.CARTESIAN,
                        data: [model],
                        scenegraph: model.scenegraphNode ?
                            loadGLTF2(model.scenegraphNode, url2gltf[model.scenegraph]) :
                            model.scenegraph,
                        // eslint-disable-next-line @typescript-eslint/naming-convention
                        _lighting: model._lighting,
                        getTransformMatrix: model.transformMatrix,
                        getColor: (_b = model.color) !== null && _b !== void 0 ? _b : [0, 255, 0, 0.5 * 255],
                        parameters: { depthMask: !model.zoomBasedOpacity && (model.opacity === undefined || model.opacity === 1) }
                    }));
                }
            }
            else if (geometry === 'text') {
                layers.push(textLayer('text', nodes.filter(n => n.unpickable), { pickable: false }));
                layers.push(textLayer('textPickable', nodes.filter(n => !n.unpickable), { pickable: true }));
            }
            else if (geometry === 'wireframe') {
                layers.push(meshLayer(geometry, nodes, { wireframe: true, pickable: false, geometry }));
            }
            else {
                layers.push(meshLayer(geometry, nodes.filter(n => n.unpickable), { wireframe: false, pickable: false, geometry }));
                layers.push(meshLayer(`${geometry}Pickable`, nodes.filter(n => !n.unpickable), { wireframe: false, pickable: true, geometry }));
            }
        }
        if (state.doCollisions) {
            doCollisions(state.data);
        }
        return layers.filter(l => !!l);
    }
    getPickingInfo(e) {
        return e.info;
    }
}
BodyUILayer.layerName = 'BodyUILayer';
BodyUILayer.gltfCache = {};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9keS11aS1sYXllci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2NjZi1ib2R5LXVpL3NyYy9saWIvYm9keS11aS1sYXllci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxzREFBc0Q7QUFDdEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxlQUFlLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RSxPQUFPLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBWSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUd4QyxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUc3RCxTQUFTLFNBQVMsQ0FBQyxFQUFVLEVBQUUsSUFBd0IsRUFBRSxPQUFtQztJQUMxRixJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQzlCLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO1NBQU07UUFDTCxJQUFJLElBQWMsQ0FBQztRQUNuQixRQUFRLE9BQU8sQ0FBQyxRQUFRLEVBQUU7WUFDeEIsS0FBSyxRQUFRO2dCQUNYLElBQUksR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO2dCQUM1QixNQUFNO1lBQ1IsS0FBSyxNQUFNO2dCQUNULElBQUksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO2dCQUMxQixNQUFNO1lBQ1IsS0FBSyxVQUFVO2dCQUNiLElBQUksR0FBRyxJQUFJLGdCQUFnQixFQUFFLENBQUM7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YWZlLWNhbGwgKi9cbmltcG9ydCB7IENvbXBvc2l0ZUxheWVyLCBDT09SRElOQVRFX1NZU1RFTSB9IGZyb20gJ0BkZWNrLmdsL2NvcmUnO1xuaW1wb3J0IHsgVGV4dExheWVyIH0gZnJvbSAnQGRlY2suZ2wvbGF5ZXJzJztcbmltcG9ydCB7IFNjZW5lZ3JhcGhMYXllciwgU2ltcGxlTWVzaExheWVyIH0gZnJvbSAnQGRlY2suZ2wvbWVzaC1sYXllcnMnO1xuaW1wb3J0IHsgQ29uZUdlb21ldHJ5LCBDdWJlR2VvbWV0cnksIEN5bGluZGVyR2VvbWV0cnksIEdlb21ldHJ5LCBTcGhlcmVHZW9tZXRyeSB9IGZyb20gJ0BsdW1hLmdsL2NvcmUnO1xuaW1wb3J0IHsgTWF0cml4NCB9IGZyb20gJ0BtYXRoLmdsL2NvcmUnO1xuXG5pbXBvcnQgeyBTcGF0aWFsU2NlbmVOb2RlIH0gZnJvbSAnLi9zaGFyZWQvc3BhdGlhbC1zY2VuZS1ub2RlJztcbmltcG9ydCB7IGxvYWRHTFRGLCBsb2FkR0xURjIsIHJlZ2lzdGVyR0xURkxvYWRlcnMgfSBmcm9tICcuL3V0aWwvbG9hZC1nbHRmJztcbmltcG9ydCB7IGRvQ29sbGlzaW9ucyB9IGZyb20gJy4vdXRpbC9zcGF0aWFsLXNjZW5lLWNvbGxpZGVyJztcblxuXG5mdW5jdGlvbiBtZXNoTGF5ZXIoaWQ6IHN0cmluZywgZGF0YTogU3BhdGlhbFNjZW5lTm9kZVtdLCBvcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IHVua25vd24gfSk6IFNpbXBsZU1lc2hMYXllcjx1bmtub3duPiB8IHVuZGVmaW5lZCB7XG4gIGlmICghZGF0YSB8fCBkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgbGV0IG1lc2g6IEdlb21ldHJ5O1xuICAgIHN3aXRjaCAob3B0aW9ucy5nZW9tZXRyeSkge1xuICAgICAgY2FzZSAnc3BoZXJlJzpcbiAgICAgICAgbWVzaCA9IG5ldyBTcGhlcmVHZW9tZXRyeSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2NvbmUnOlxuICAgICAgICBtZXNoID0gbmV3IENvbmVHZW9tZXRyeSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2N5bGluZGVyJzpcbiAgICAgICAgbWVzaCA9IG5ldyBDeWxpbmRlckdlb21ldHJ5KCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY3ViZSc6XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBtZXNoID0gbmV3IEN1YmVHZW9tZXRyeSgpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBTaW1wbGVNZXNoTGF5ZXIoe1xuICAgICAgLi4ue1xuICAgICAgICBpZCxcbiAgICAgICAgcGlja2FibGU6IHRydWUsXG4gICAgICAgIGF1dG9IaWdobGlnaHQ6IGZhbHNlLFxuICAgICAgICBoaWdobGlnaHRDb2xvcjogWzMwLCAxMzYsIDIyOSwgMjU1XSxcbiAgICAgICAgY29vcmRpbmF0ZVN5c3RlbTogQ09PUkRJTkFURV9TWVNURU0uQ0FSVEVTSUFOLFxuICAgICAgICBkYXRhLFxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICBtZXNoOiBtZXNoIGFzIGFueSxcbiAgICAgICAgd2lyZWZyYW1lOiBmYWxzZSxcbiAgICAgICAgZ2V0VHJhbnNmb3JtTWF0cml4OiAoZCkgPT4gKGQgYXMgeyB0cmFuc2Zvcm1NYXRyaXg6IG51bWJlcltdW10gfSkudHJhbnNmb3JtTWF0cml4LFxuICAgICAgICBnZXRDb2xvcjogKGQpID0+IChkIGFzIHsgY29sb3I6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdIH0pLmNvbG9yIHx8IFsyNTUsIDI1NSwgMjU1LCAwLjkqMjU1XVxuICAgICAgfSxcbiAgICAgIC4uLm9wdGlvbnNcbiAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiB0ZXh0TGF5ZXIoaWQ6IHN0cmluZywgZGF0YTogU3BhdGlhbFNjZW5lTm9kZVtdLCBvcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IHVua25vd24gfSk6IFRleHRMYXllcjx1bmtub3duPiB8IHVuZGVmaW5lZCB7XG4gIGlmICghZGF0YSB8fCBkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5ldyBUZXh0TGF5ZXIoe1xuICAgICAgLi4ue1xuICAgICAgICBpZCxcbiAgICAgICAgcGlja2FibGU6IHRydWUsXG4gICAgICAgIGRhdGE6IGRhdGEubWFwKGQgPT4gKHsgLi4uZCwgcG9zaXRpb246IG5ldyBNYXRyaXg0KGQudHJhbnNmb3JtTWF0cml4KS5nZXRUcmFuc2xhdGlvbigpIH0pKSxcbiAgICAgICAgZ2V0VGV4dDogKGQpID0+IChkIGFzIHsgdGV4dDogc3RyaW5nIH0pLnRleHQsXG4gICAgICAgIGdldFBvc2l0aW9uOiAoZCkgPT4gKGQgYXMgeyBwb3NpdGlvbjogW251bWJlciwgbnVtYmVyXSB9KS5wb3NpdGlvbixcbiAgICAgICAgZ2V0Q29sb3I6IChkKSA9PiAoZCBhcyB7IGNvbG9yOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlciwgbnVtYmVyXSB9KS5jb2xvclxuICAgICAgfSxcbiAgICAgIC4uLm9wdGlvbnNcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQm9keVVJTGF5ZXIgZXh0ZW5kcyBDb21wb3NpdGVMYXllcjxTcGF0aWFsU2NlbmVOb2RlPiB7XG4gIHN0YXRpYyByZWFkb25seSBsYXllck5hbWUgPSAnQm9keVVJTGF5ZXInO1xuICBzdGF0aWMgcmVhZG9ubHkgZ2x0ZkNhY2hlOiB7IFt1cmw6IHN0cmluZ106IFByb21pc2U8QmxvYj4gfSA9IHt9O1xuXG4gIGluaXRpYWxpemVTdGF0ZSgpOiB2b2lkIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IHRoaXMucHJvcHM7XG4gICAgdGhpcy5zZXRTdGF0ZSh7IGRhdGE6IGRhdGEgPz8gW10sIHpvb21PcGFjaXR5OiAwLjgsIGRvQ29sbGlzaW9uczogZmFsc2UgfSk7XG4gICAgcmVnaXN0ZXJHTFRGTG9hZGVycygpO1xuICB9XG5cbiAgcmVuZGVyTGF5ZXJzKCk6IHVua25vd25bXSB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlIGFzIHsgZGF0YTogU3BhdGlhbFNjZW5lTm9kZVtdOyB6b29tT3BhY2l0eTogbnVtYmVyOyBkb0NvbGxpc2lvbnM6IGJvb2xlYW4gfTtcbiAgICBjb25zdCBnZW9tZXRyaWVzOiBSZWNvcmQ8c3RyaW5nLCBTcGF0aWFsU2NlbmVOb2RlW10+ID0ge1xuICAgICAgJ3NwaGVyZSc6IFtdLCAnY29uZSc6IFtdLCAnY3lsaW5kZXInOiBbXSwgJ2N1YmUnOiBbXSwgJ3RleHQnOiBbXSwgJ3dpcmVmcmFtZSc6IFtdLCAnc2NlbmVncmFwaCc6IFtdXG4gICAgfTtcblxuICAgIGZvciAoY29uc3Qgbm9kZSBvZiBzdGF0ZS5kYXRhKSB7XG4gICAgICBjb25zdCBnZW9tZXRyeSA9IG5vZGUuZ2VvbWV0cnkgPz8gJ2N1YmUnO1xuICAgICAgaWYgKG5vZGUuc2NlbmVncmFwaCkge1xuICAgICAgICBnZW9tZXRyaWVzLnNjZW5lZ3JhcGgucHVzaChub2RlKTtcbiAgICAgIH0gZWxzZSBpZiAoZ2VvbWV0cmllc1tnZW9tZXRyeV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBnZW9tZXRyaWVzW2dlb21ldHJ5XS5wdXNoKG5vZGUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgY29uc3QgdXJsMmdsdGY6IHsgW3VybDogc3RyaW5nXTogUHJvbWlzZTxhbnk+IH0gPSB7fTtcbiAgICBmb3IgKGNvbnN0IG0gb2YgZ2VvbWV0cmllcy5zY2VuZWdyYXBoKSB7XG4gICAgICBpZiAobS5zY2VuZWdyYXBoICYmIG0uc2NlbmVncmFwaE5vZGUgJiYgIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh1cmwyZ2x0ZiwgbS5zY2VuZWdyYXBoKSkge1xuICAgICAgICB1cmwyZ2x0ZlttLnNjZW5lZ3JhcGhdID0gbG9hZEdMVEYoeyBzY2VuZWdyYXBoOiBtLnNjZW5lZ3JhcGggfSBhcyBTcGF0aWFsU2NlbmVOb2RlLCBCb2R5VUlMYXllci5nbHRmQ2FjaGUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGxheWVyczogdW5rbm93bltdID0gW107XG4gICAgZm9yIChjb25zdCBbZ2VvbWV0cnksIG5vZGVzXSBvZiBPYmplY3QuZW50cmllcyhnZW9tZXRyaWVzKSkge1xuICAgICAgaWYgKGdlb21ldHJ5ID09PSAnc2NlbmVncmFwaCcpIHtcbiAgICAgICAgZm9yIChjb25zdCBtb2RlbCBvZiBub2Rlcykge1xuICAgICAgICAgIGxheWVycy5wdXNoKFxuICAgICAgICAgICAgbmV3IFNjZW5lZ3JhcGhMYXllcih7XG4gICAgICAgICAgICAgIGlkOiAnbW9kZWxzLScgKyBtb2RlbFsnQGlkJ10sXG4gICAgICAgICAgICAgIG9wYWNpdHk6IG1vZGVsLnpvb21CYXNlZE9wYWNpdHkgPyBzdGF0ZS56b29tT3BhY2l0eSA6IChtb2RlbC5vcGFjaXR5ICE9PSB1bmRlZmluZWQgPyBtb2RlbC5vcGFjaXR5IDogMS4wKSxcbiAgICAgICAgICAgICAgcGlja2FibGU6ICFtb2RlbC51bnBpY2thYmxlLFxuICAgICAgICAgICAgICBjb29yZGluYXRlU3lzdGVtOiBDT09SRElOQVRFX1NZU1RFTS5DQVJURVNJQU4sXG4gICAgICAgICAgICAgIGRhdGE6IFttb2RlbF0sXG4gICAgICAgICAgICAgIHNjZW5lZ3JhcGg6IG1vZGVsLnNjZW5lZ3JhcGhOb2RlID9cbiAgICAgICAgICAgICAgICBsb2FkR0xURjIobW9kZWwuc2NlbmVncmFwaE5vZGUsIHVybDJnbHRmW21vZGVsLnNjZW5lZ3JhcGggYXMgc3RyaW5nXSkgOlxuICAgICAgICAgICAgICAgIG1vZGVsLnNjZW5lZ3JhcGggYXMgdW5rbm93biBhcyBVUkwsXG4gICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbmFtaW5nLWNvbnZlbnRpb25cbiAgICAgICAgICAgICAgX2xpZ2h0aW5nOiBtb2RlbC5fbGlnaHRpbmcsIC8vICdwYnInIHwgdW5kZWZpbmVkXG4gICAgICAgICAgICAgIGdldFRyYW5zZm9ybU1hdHJpeDogbW9kZWwudHJhbnNmb3JtTWF0cml4IGFzIHVua25vd24gYXMgbnVtYmVyW11bXSxcbiAgICAgICAgICAgICAgZ2V0Q29sb3I6IG1vZGVsLmNvbG9yID8/IFswLCAyNTUsIDAsIDAuNSoyNTVdLFxuICAgICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IGRlcHRoTWFzazogIW1vZGVsLnpvb21CYXNlZE9wYWNpdHkgJiYgKG1vZGVsLm9wYWNpdHkgPT09IHVuZGVmaW5lZCB8fCBtb2RlbC5vcGFjaXR5ID09PSAxKSB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoZ2VvbWV0cnkgPT09ICd0ZXh0Jykge1xuICAgICAgICBsYXllcnMucHVzaCh0ZXh0TGF5ZXIoJ3RleHQnLCBub2Rlcy5maWx0ZXIobiA9PiBuLnVucGlja2FibGUpLCB7IHBpY2thYmxlOiBmYWxzZSB9KSk7XG4gICAgICAgIGxheWVycy5wdXNoKHRleHRMYXllcigndGV4dFBpY2thYmxlJywgbm9kZXMuZmlsdGVyKG4gPT4gIW4udW5waWNrYWJsZSksIHsgcGlja2FibGU6IHRydWUgfSkpO1xuICAgICAgfSBlbHNlIGlmIChnZW9tZXRyeSA9PT0gJ3dpcmVmcmFtZScpIHtcbiAgICAgICAgbGF5ZXJzLnB1c2gobWVzaExheWVyKGdlb21ldHJ5LCBub2RlcywgeyB3aXJlZnJhbWU6IHRydWUsIHBpY2thYmxlOiBmYWxzZSwgZ2VvbWV0cnkgfSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGF5ZXJzLnB1c2gobWVzaExheWVyKGdlb21ldHJ5LCBub2Rlcy5maWx0ZXIobiA9PiBuLnVucGlja2FibGUpLCB7IHdpcmVmcmFtZTogZmFsc2UsIHBpY2thYmxlOiBmYWxzZSwgZ2VvbWV0cnkgfSkpO1xuICAgICAgICBsYXllcnMucHVzaChtZXNoTGF5ZXIoYCR7Z2VvbWV0cnl9UGlja2FibGVgLCBub2Rlcy5maWx0ZXIobiA9PiAhbi51bnBpY2thYmxlKSwgeyB3aXJlZnJhbWU6IGZhbHNlLCBwaWNrYWJsZTogdHJ1ZSwgZ2VvbWV0cnkgfSkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChzdGF0ZS5kb0NvbGxpc2lvbnMpIHtcbiAgICAgIGRvQ29sbGlzaW9ucyhzdGF0ZS5kYXRhKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbGF5ZXJzLmZpbHRlcihsID0+ICEhbCk7XG4gIH1cblxuICBnZXRQaWNraW5nSW5mbyhcbiAgICBlOiBQYXJhbWV0ZXJzPENvbXBvc2l0ZUxheWVyPFNwYXRpYWxTY2VuZU5vZGU+WydnZXRQaWNraW5nSW5mbyddPlswXVxuICApOiBSZXR1cm5UeXBlPENvbXBvc2l0ZUxheWVyPFNwYXRpYWxTY2VuZU5vZGU+WydnZXRQaWNraW5nSW5mbyddPiB7XG4gICAgcmV0dXJuIGUuaW5mbztcbiAgfVxufVxuIl19